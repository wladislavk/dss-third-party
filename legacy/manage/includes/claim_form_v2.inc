<?php
namespace Ds3\Libraries\Legacy;

$is_front_office = empty($is_back_office);

require_once __DIR__ . '/../admin/includes/claim_functions.php';
require_once __DIR__ . '/../admin/includes/claim-status-switcher.inc';

$isHistoricView = !empty($isHistoricView) || isset($_GET['history_id']);
$historyId = intval($_GET['history_id']);
$isDebug = config('app.debug') && config('app.debugClaims');

$claimId = intval($_GET['insid']);
$patientId = intval($_GET['pid']);

$db = new Db();

$minimalClaimData = $db->getRow("SELECT status, primary_claim_id
    FROM dental_insurance WHERE insuranceid = '$claimId' AND patientid = '$patientId'");
$status = array_get($minimalClaimData, 'status', 0);
$primaryClaimId = array_get($minimalClaimData, 'primary_claim_id', 0);

$isSecondary = !empty($primaryClaimId) || ($_GET['instype'] == 2);
$isSent = ClaimFormData::isStatus('sent', $status);
$isPending = ClaimFormData::isStatus('pending', $status);
$isSecondaryPending = $isSecondary && $isPending;
$isDispute = ClaimFormData::isStatus('dispute', $status);
$isRejected = ClaimFormData::isStatus('rejected', $status);

$isNewClaim = !$claimId;

$patientData = $db->getRow("SELECT * FROM dental_patients WHERE patientid = '$patientId'");
$docId = intval($patientData['docid']);

// deleting specified claim form
if (!$isHistoricView && !empty($_REQUEST["delid"]) ? $_REQUEST["delid"] : '') {
    $deleteId = intval($_REQUEST['delid']);
    $db->query("DELETE FROM dental_procedure WHERE procedureid = '$deleteId'");

    $msg = "Deleted Successfully";
    ?>
    <script type="text/javascript">
        window.location="delete_insurance.php?pid=<?= $patientId ?>&msg=<?= $msg ?>&delid=<?= $deleteId ?>";
    </script>
    <?php
    trigger_error("Die called", E_USER_ERROR); // already did a javascript redirect...just die
}

if (!$isHistoricView && !empty($_POST['ex_statusbtn'])) { ?>
    <script type="text/javascript">
        window.location = '<?= $called_from ?>?insid=<?= $claimId ?>&checkstatus=1&pid=<?= $patientId ?>';
    </script>
    <?php
    trigger_error("Die called", E_USER_ERROR);
} elseif (
    !$isHistoricView &&
    !empty($_POST['insurancesub']) &&
    (
        $_POST['insurancesub'] == 1 ||
        !empty($_POST['ex_pagebtn']) ||
        !empty($_POST['preserve_status'])
    )
) {
    // If the status is pending, then confirm changes to ledger transactions
    if ($isPending && hasLedgerTransactionsChanged($claimId, $_POST['service_lines'])) { ?>
        <script type="text/javascript">
            window.location = "manage_claims.php?msg=Error sending claim: Frontoffice user has altered claim. Please reload and try again.";
        </script>
        <?php
        trigger_error("Die called", E_USER_ERROR);
    }

    // Save claim
    $claimId = savePaperClaimForm($claimId, $patientId, $_POST, $status, !$is_front_office);

    if ($isNewClaim) {
        $msg = "Claim Created Successfully";
        ?>
        <script type="text/javascript">
            window.location = '<?= $called_from ?>?pid=<?= $patientId ?>&msg=<?= $msg ?>';
        </script>
        <?php
        trigger_error("Die called", E_USER_ERROR); // already did a javascript redirect...just die
    } else {
        $msg = "Claim Edited Successfully";

        // Single lines in redirection or the parser fails
        ?>
        <script type="text/javascript">
            <?php if (isset($_POST['ex_pagebtn_elec'])) { ?>
                window.location = '<?= $called_from ?>?status=0&insid=<?= $claimId ?>&sendins=1&pid=<?= $patientId ?>&msg=<?= $msg ?>';
            <?php } elseif (isset($_POST['elec_save'])) { ?>
                window.location = '<?= $electronic_form ?>';
            <?php } else { ?>
                window.location = '<?= $called_from ?>?status=0&insid=<?= $claimId ?>&showins=1&pid=<?= $patientId ?>&msg=<?= $msg ?>';
            <?php } ?>
        </script>
        <?php
        trigger_error("Die called", E_USER_ERROR); // already did a javascript redirect...just die
    }
}

/**
 * If claim is pending, regenerate claim data.
 * Otherwise, allow to load already saved data.
 *
 * Only pending states are primary pending, and secondary pending
 */
if ($isHistoricView) {
    $claimData = ClaimFormData::historicClaimData($claimId, $historyId);
} elseif ($isPending) {
    $claimData = ClaimFormData::dynamicDataForClaim($claimId);
} else {
    $claimData = ClaimFormData::storedDataForClaim($claimId, $patientId);
}

$isBackOffice = !empty($is_back_office) || empty($is_front_office);
$backOfficeClaimsConditional = backOfficeClaimsConditional();
$belongsToBackOffice = (bool)$db->getColumn("SELECT $backOfficeClaimsConditional AS belongs_to_bo
    FROM dental_insurance claim
    LEFT JOIN dental_patients p ON claim.patientid = p.patientid
    LEFT JOIN dental_users users ON claim.docid = users.userid
    WHERE claim.insuranceid = '$claimId'
", 'belongs_to_bo');

$referencedClaimId = intval($claimData['primary_claim_id']);
$fdf_file = !empty($claimData['primary_fdf']) ? $claimData['primary_fdf'] : '';
$p_m_eligible_payer_id = !empty($claimData['p_m_eligible_payer_id']) ? $claimData['p_m_eligible_payer_id'] : '';
$p_m_eligible_payer_name = !empty($claimData['p_m_eligible_payer_name']) ? $claimData['p_m_eligible_payer_name'] : '';
$s_m_eligible_payer_id = !empty($claimData['s_m_eligible_payer_id']) ? $claimData['s_m_eligible_payer_id'] : '';
$s_m_eligible_payer_name = !empty($claimData['s_m_eligible_payer_name']) ? $claimData['s_m_eligible_payer_name'] : '';

$pica1 = st($claimData['pica1']);
$pica2 = st($claimData['pica2']);
$pica3 = st($claimData['pica3']);
$p_m_dss_file = $patientData['p_m_dss_file'];

if (!empty($patientData['exclusive'])){ $p_m_dss_file = 1; }

$s_m_dss_file = $patientData['s_m_dss_file'];
$patient_lastname = st($claimData['patient_lastname']);
$patient_firstname = st($claimData['patient_firstname']);
$patient_middle = st($claimData['patient_middle']);
$patient_dob = st($claimData['patient_dob']);
$patient_sex = st($claimData['patient_sex']);
$responsibility_sequence = $claimData['responsibility_sequence'];

$insurancetype = st($claimData['insurance_type']);
$other_insurancetype = $claimData['other_insurance_type'];
$other_insured_firstname = st($claimData['other_insured_firstname']);
$other_insured_lastname = st($claimData['other_insured_lastname']);
$other_insured_middle = st($claimData['other_insured_middle']);
$other_insured_dob = st($claimData['other_insured_dob']);

if (empty($other_insured_insurance_plan)) {
    $other_insured_insurance_plan = st($claimData['other_insured_insurance_plan']);
}

$other_insured_policy_group_feca = st($claimData['other_insured_policy_group_feca']);
$insured_id_number = st($claimData['insured_id_number']);
$other_insured_id_number = st($claimData['other_insured_id_number']);
$insured_firstname = st($claimData['insured_firstname']);
$insured_middle = st($claimData['insured_middle']);
$insured_lastname = st($claimData['insured_lastname']);
$insured_dob = st($claimData['insured_dob']);
$insured_insurance_plan = st($claimData['insured_insurance_plan']);
$insured_policy_group_feca = st($claimData['insured_policy_group_feca']);
$insured_address = st($claimData['insured_address']);
$insured_city = st($claimData['insured_city']);
$insured_state = st($claimData['insured_state']);
$insured_zip = st($claimData['insured_zip']);

list($insured_phone_code, $insured_phone) = parsePhoneNumber($claimData['insured_phone_code'], $claimData['insured_phone']);

$insured_sex = st($claimData['insured_sex']);
$patient_relation_insured = st($claimData['patient_relation_insured']);
$patient_relation_other_insured = st($claimData['patient_relation_other_insured']);

$patient_address = st($claimData['patient_address']);
$patient_city = st($claimData['patient_city']);
$patient_state = st($claimData['patient_state']);
$patient_status = st($claimData['patient_status']);
$patient_zip = st($claimData['patient_zip']);

list($patient_phone_code, $patient_phone) = parsePhoneNumber($claimData['patient_phone_code'], $claimData['patient_phone']);

$employment = st($claimData['employment']);
$auto_accident = st($claimData['auto_accident']);
$auto_accident_place = st($claimData['auto_accident_place']);
$other_accident = st($claimData['other_accident']);
$another_plan = st($claimData['another_plan']);
$patient_signature = st($claimData['patient_signature']);
$patient_signed_date = st($claimData['patient_signed_date']);
$insured_signature = st($claimData['insured_signature']);
$date_current = st($claimData['date_current']);
$current_qual = st($claimData['current_qual']);
$same_illness_qual = st($claimData['same_illness_qual']);
$date_same_illness = st($claimData['date_same_illness']);
$unable_date_from = st($claimData['unable_date_from']);
$unable_date_to = st($claimData['unable_date_to']);
$name_referring_provider_qualifier = st($claimData['name_referring_provider_qualifier']);
$referring_provider = st($claimData['referring_provider']);
$field_17a_dd = st($claimData['field_17a_dd']);
$field_17a = st($claimData['field_17a']);
$diagnosising_npi = st($claimData['field_17b']);
$hospitalization_date_from = st($claimData['hospitalization_date_from']);
$hospitalization_date_to = st($claimData['hospitalization_date_to']);
$reserved_local_use1 = st($claimData['reserved_local_use1']);
$outside_lab = st($claimData['outside_lab']);
$s_charges = st($claimData['s_charges']);

$icd_ind = st($claimData['icd_ind']);

$diagnosis_a = st($claimData['diagnosis_a']);
$diagnosis_b = st($claimData['diagnosis_b']);
$diagnosis_c = st($claimData['diagnosis_c']);
$diagnosis_d = st($claimData['diagnosis_d']);
$diagnosis_e = st($claimData['diagnosis_e']);
$diagnosis_f = st($claimData['diagnosis_f']);
$diagnosis_g = st($claimData['diagnosis_g']);
$diagnosis_h = st($claimData['diagnosis_h']);
$diagnosis_i = st($claimData['diagnosis_i']);
$diagnosis_j = st($claimData['diagnosis_j']);
$diagnosis_k = st($claimData['diagnosis_k']);
$diagnosis_l = st($claimData['diagnosis_l']);
$resubmission_code_fill = st($claimData['resubmission_code_fill']);
$original_ref_no = st($claimData['original_ref_no']);
$prior_authorization_number = st($claimData['prior_authorization_number']);
$federal_tax_id_number = st($claimData['federal_tax_id_number']);
$ssn = st($claimData['ssn']);
$ein = st($claimData['ein']);
$patient_account_no = st($claimData['patient_account_no']);
$accept_assignment = st($claimData['accept_assignment']);
$total_charge = st($claimData['total_charge']);
$amount_paid = st($claimData['amount_paid']);
$balance_due = st($claimData['balance_due']);
$nucc_8a = st($claimData['nucc_8a']);
$nucc_8b = st($claimData['nucc_8b']);
$nucc_9b = st($claimData['nucc_9b']);
$claim_codes = st($claimData['claim_codes']);
$other_claim_id = st($claimData['other_claim_id']);
$nucc_9c = st($claimData['nucc_9c']);
$nucc_30 = st($claimData['nucc_30']);
$signature_physician = st($claimData['signature_physician']);
$physician_signed_date = dateFormat($claimData['physician_signed_date']);
$service_facility_info_name = st($claimData['service_facility_info_name']);
$service_facility_info_address = st($claimData['service_facility_info_address']);
$service_facility_info_city = st($claimData['service_facility_info_city']);
$service_facility_info = parseCityStateZip($service_facility_info_city);
$service_info_a = st($claimData['service_info_a']);
$service_info_dd = st($claimData['service_info_dd']);
$service_info_b_other = st($claimData['service_info_b_other']);

list($billing_provider_phone_code, $billing_provider_phone) = parsePhoneNumber($claimData['billing_provider_phone_code'], $claimData['billing_provider_phone']);

$billing_provider_name = st($claimData['billing_provider_name']);
$billing_provider_address = st($claimData['billing_provider_address']);
$billing_provider_city = st($claimData['billing_provider_city']);
$billing_provider_info = parseCityStateZip($billing_provider_city);
$billing_provider_a = st($claimData['billing_provider_a']);
$billing_provider_dd = st($claimData['billing_provider_dd']);
$billing_provider_b_other = st($claimData['billing_provider_b_other']);
$status = st($claimData['status']);

$patient_dob = dateFormat($patient_dob, false);
$insured_dob = dateFormat($insured_dob, false);
$date_current = dateFormat($date_current, false);
$date_same_illness = dateFormat($date_same_illness, false);
$unable_date_from = dateFormat($unable_date_from, false);
$unable_date_to = dateFormat($unable_date_to, false);
$hospitalization_date_from = dateFormat($hospitalization_date_from, false);
$hospitalization_date_to = dateFormat($hospitalization_date_to, false);
$patient_signed_date = dateFormat($patient_signed_date, false);
$physician_signed_date = dateFormat($physician_signed_date, false);

list($patient_phone_code, $patient_phone) = parsePhoneNumber($patient_phone_code, $patient_phone);
list($insured_phone_code, $insured_phone) = parsePhoneNumber($insured_phone_code, $insured_phone);
list($billing_provider_phone_code, $billing_provider_phone) = parsePhoneNumber($billing_provider_phone_code, $billing_provider_phone);

/**
 * These results might not reflect accurately the state of the claim at the moment it was stored
 */
$acceptAssignment = isOptionSelected($accept_assignment) || $accept_assignment == 'A';

$placeServices = $db->getResults('SELECT place_service, description FROM dental_place_service ps WHERE status = 1');
$modifierCodes = $db->getResults('SELECT * FROM dental_modifier_code');

$transactions = ClaimFormData::associatedLedgerItems($claimId);

$realTotalAmount = 0;
$oldestServiceDate = null;

foreach ($transactions as $array) {
    $realTotalAmount += $array['amount'];

    if (is_null($oldestServiceDate)) {
        $oldestServiceDate = dateToTime($array['service_date']);
    } else {
        $currentServiceDate = dateToTime($array['service_date']);
        $oldestServiceDate = $oldestServiceDate < $currentServiceDate ? $oldestServiceDate : $currentServiceDate;
    }
}

/**
 * ICD indicator default relies on service dates
 */
$total_charge = empty($total_charge) ? 0.00 : number_format($total_charge, 2, '.', '');
$amount_paid = empty($amount_paid) ? 0.00 : number_format($amount_paid, 2, '.', '');
$balance_due = empty($balance_due) ? 0.00 : number_format($balance_due, 2, '.', '');

// We only calculate the dollar amounts when a new claim is created because
// right now we aren't appending any trxns to an existing claim.
if (!$isHistoricView && $isPending) {
    // get total_charge
    if (!$isSecondary) {
        $sql = "SELECT SUM(ledger.amount) as 'total_charge'
            FROM dental_ledger ledger
            JOIN dental_transaction_code trxn_code ON trxn_code.transaction_code = ledger.transaction_code 
            WHERE ledger.status = '" . DSS_TRXN_PENDING . "' 
            AND ledger.patientid = '$patientId' 
            AND ledger.docid = '$docId' 
            AND trxn_code.docid = '$docId' 
            AND trxn_code.type = '" . DSS_TRXN_TYPE_MED . "' 
            ORDER BY ledger.service_date ASC";
        $charge_my = $db->getRow($sql);

        if (!empty($charge_my)) {
            $charge_row = $charge_my;
            $total_charge = $charge_row['total_charge'];
        }
    } else {
        $sql = "SELECT SUM(ledger.amount) as 'total_charge' 
            FROM dental_ledger ledger 
            JOIN dental_transaction_code trxn_code ON trxn_code.transaction_code = ledger.transaction_code 
            WHERE ledger.primary_claim_id = '$referencedClaimId' 
            AND ledger.patientid = '$patientId' 
            AND ledger.docid = '$docId' 
            AND trxn_code.docid = '$docId' 
            AND trxn_code.type = '" . DSS_TRXN_TYPE_MED . "' 
            ORDER BY ledger.service_date ASC";
        $charge_my = $db->getRow($sql);

        if (!empty($charge_my)) {
            $charge_row = $charge_my;
            $total_charge = $charge_row['total_charge'];
        }
    }

    // get amount paid
    $sql = "SELECT SUM(ledger.paid_amount) as 'amount_paid' 
        FROM dental_ledger ledger 
        JOIN dental_transaction_code trxn_code ON trxn_code.transaction_code = ledger.transaction_code 
        WHERE ledger.status = '" . DSS_TRXN_PENDING . "' 
        AND ledger.patientid = '$patientId' 
        AND ledger.docid = '$docId' 
        AND trxn_code.docid = '$docId' 
        AND trxn_code.type IN ('" . DSS_TRXN_TYPE_PATIENT . "','" . DSS_TRXN_TYPE_INS . "','" . DSS_TRXN_TYPE_ADJ . "') 
        ORDER BY ledger.service_date ASC";

    if ($isSecondary && $isPending) {
        $sql = "SELECT sum(dlp.amount) as amount_paid
            from dental_ledger dl
            LEFT JOIN dental_users p ON dl.producerid=p.userid
            LEFT JOIN dental_ledger_payment dlp on dlp.ledgerid=dl.ledgerid
            where dl.docid='".$docId."' and dl.patientid='$patientId'
            AND primary_claim_id='$referencedClaimId'
            AND dlp.amount != 0
            AND dlp.payer = 0";
    }

    $paid_my = $db->getRow($sql);

    if (!empty($paid_my)) {
        $paid_row = $paid_my;
        $amount_paid = $paid_row['amount_paid'];
    }

    // re-calculate balance due
    $balance_due = $total_charge - $amount_paid;

    // Override value from faulty sql queries
    if ($isPending) {
        $total_charge = $realTotalAmount;
    }

    // format calculations
    $total_charge = number_format($total_charge, 2, '.', '');
    $amount_paid = number_format($amount_paid, 2, '.', '');
}

$total_charge = preg_replace('/[^\d\.]+/', '', $total_charge);
$amount_paid = preg_replace('/[^\d\.]+/', '', $amount_paid);

$eResponse = [];
$eligibleResponse = [];

if (!$isHistoricView && $isRejected) {
    $eDescriptions = eligibleDetailsFromClaimId($claimId);
    $eResponse = $eDescriptions['e_response'];
    $eligibleResponse = $eDescriptions['latest_rejection'] ?: $eDescriptions['eligible_response'];
}

$insuranceCompanyId = intval($isSecondary ? $patientData['s_m_ins_co'] : $patientData['p_m_ins_co']);
$insuranceCompanyData = $db->getRow("SELECT * FROM dental_contact WHERE contactid ='$insuranceCompanyId'");
$insuranceCompanyData = $insuranceCompanyData ?: [];

$qualifiers = $db->getResults("SELECT * FROM dental_qualifier WHERE status = 1 ORDER BY sortby");

if ($isSecondary) {
    $counterClaimId = $referencedClaimId;
} else {
    $counterClaimId = $db->getColumn("SELECT insuranceid
        FROM dental_insurance
        WHERE primary_claim_id = '$claimId'", 'insuranceid');
}

$transactionCodes = $db->getResults("SELECT transaction_code, description
    FROM dental_transaction_code
    WHERE docid = '$docId'
    AND status = 1
    ORDER BY sortby");

$otherRelationships = [
    '18' => 'Self',
    '01' => 'Spouse',
    '19' => 'Child',
    'G8' => 'Other',
    '20' => 'Employee',
    '21' => 'Unknown',
    '39' => 'Organ Donor',
    '40' => 'Cadaver Donor',
    '53' => 'Life Partner',
];
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Health Insurance Paper Claim Form</title>
    <link rel="stylesheet" href="/manage/form/form.css?v=<?= time() ?>" type="text/css" />
    <style type="text/css">
        .style1 {
            font-size: 16px;
        }
        input {
            text-transform: uppercase;
        }
        .text-center {
            text-align: center;
        }
    </style>
    <link rel="stylesheet" href="https://eligible.com/css/eligible-claim-1500-2014.min.css" />
    <link rel="stylesheet" href="<?php echo $admin_path?>popup/popup.css" media="screen" />
    <script type="text/javascript" src="/manage/admin/js/tracekit.js"></script>
    <script type="text/javascript" src="/manage/admin/js/tracekit.handler.js"></script>
    <script type="text/javascript" src="/manage/admin/script/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="/manage/script/autocomplete_local.js?v=<?= time() ?>"></script>
    <script type="text/javascript" src="/manage/script/validation.js"></script>
    <script type="text/javascript" src="<?php echo $manage_path?>3rdParty/input_mask/jquery.maskedinput-1.3.min.js"></script>
    <script type="text/javascript" src="<?php echo $manage_path?>script/masks.js?v=<?= time() ?>"></script>
    <script type="text/javascript" src="<?php echo $admin_path?>popup/popup.js"></script>
    <script type="text/javascript" src="/manage/js/top.js?v=20160831"></script>
    <?php require_once __DIR__ . '/calendarinc.php' ?>
    <?php if (!$isHistoricView && $isDebug) { ?>
        <link rel="stylesheet" href="/manage/css/claim-form-mock.css?v=<?= time() ?>" />
        <script type="text/javascript" src="/manage/js/claim-form-mock-data.js?v=<?= time() ?>"></script>
        <script type="text/javascript" src="/manage/js/claim-form-mock.js?v=<?= time() ?>"></script>
    <?php } ?>
    <script type="text/javascript">
        var claimData = <?= json_encode($claimData) ?>;
    </script>
</head>
<body>
<div id="top-banner">
    <h2>Paper Claim Form</h2>
    <?php if ($isHistoricView) { ?>
        <h3 class="text-center">
            Historic snapshot of claim <?= $claimId ?>
            at <?= date('m/d/Y h:i', strtotime($claimData['updated_at'])) ?>
        </h3>
    <?php } else { ?>
        <ol>
            <li>Verify all claim details.</li>
            <li>Click "Print Claim".</li>
            <li>Download the PDF output file and print on CMS1500 form.</li>
        </ol>
        <?php if (!empty($is_front_office)) { ?>
            <input type="button" value="Back to Insurance Page" onclick="window.location='/manage/view_claim.php?claimid=<?= $claimId ?>&pid=<?= $patientId ?>'; return false;" />
        <?php } elseif ($is_back_office) { ?>
            <input type="button" value="Back to Insurance Page" onclick="window.location='manage_claims.php'; return false;" />
        <?php } ?>
    <?php } ?>
    <?php if (!$isHistoricView && ($status==DSS_CLAIM_PENDING || $status==DSS_CLAIM_REJECTED)) { ?>
        <?php if ($_SERVER['PHP_SELF'] == "/manage/admin/insurance_claim.php") { ?>
            <?php if ($_SESSION['admin_access'] == 1) { ?>
                <a href="manage_claims.php?delid=<?= intval($claimId) ?>"
                    onclick="return confirm('Are you sure you want to delete this claim?');"
                    style="float:right; color:#f00; text-decoration:none;" class="editdel dellink"
                    title="Delete Claim"
                >Delete Claim</a>
            <?php } ?>
        <?php } else { ?>
            <a href="manage_insurance.php?delid=<?php echo $claimId;?>&pid=<?php echo $_GET['pid']; ?>"
                onclick="return confirm('Are you sure you want to delete this claim?');"
                style="float:right; color:#f00; text-decoration:none;" class="editdel dellink"
                title="Delete Claim"
            >Delete Claim</a>
        <?php } ?>
    <?php } ?>
</div>
<?php claimStatusSwitcher($claimId) ?>
<?php echo (!empty($msg) ? $msg : ''); ?>
<h4>
    <?= $isSecondary ? 'Secondary' : 'Primary' ?> Claim
    <?php if (!$isHistoricView && $counterClaimId) { ?>
        (<a href="insurance_<?= !empty($is_front_office) ? '' : 'claim_' ?>v2.php?insid=<?= $counterClaimId ?>&pid=<?= $patientId ?>">
            <?= $isSecondary ? 'Primary' : 'Secondary' ?> is
            <?= $counterClaimId ?>
        </a>)
    <?php } ?>
</h4>
<form name="insurancefrm" action="<?php echo $_SERVER['PHP_SELF'];?>?insid=<?php echo (!empty($_GET['insid']) ? $_GET['insid'] : '')?>&pid=<?php echo $_GET['pid']?>" method="post" id="claim-form">
    <input type="hidden" name="insurancesub" value="1" />
    <input type="hidden" name="ed" value="<?php echo $claimId;?>" />

    <div align="right">
        <?php if (!$isHistoricView) { ?>
            <?php if ($isSent) { ?>
                Claim has been sent
                <!-- Give user ability to print claim again and update claim history -->
                <input type="submit" class="print-button" name="ex_pagebtn" value="REPRINT Claim" title="Reprint your claim.&#013;&#013;If you make changes to the CMS 1500 form they will appear on the reprint&#013;and will be saved in claim history." />
                <?php if ($is_back_office) { ?>
                    <input type="submit" class="print-button" name="ex_statusbtn" value="Check Status" />
                <?php } ?>
            <?php } else if (!empty($is_back_office)) { ?>
                <?php if($status == DSS_CLAIM_PENDING){ ?>
                    Mark Sent <input type="checkbox" name="status_chk" disabled="disabled" value="<?php echo DSS_CLAIM_SENT?>" checked="checked" />
                    <input type="hidden" name="status" value="<?php echo DSS_CLAIM_SENT?>" />
                <?php }elseif($status == DSS_CLAIM_SEC_PENDING){ ?>
                    Mark Sent <input type="checkbox" name="status_chk" disabled="disabled" value="<?php echo DSS_CLAIM_SEC_SENT?>" checked="checked" />
                    <input type="hidden" name="status" value="<?php echo DSS_CLAIM_SEC_SENT?>" />
                <?php }elseif($status == DSS_CLAIM_REJECTED){ ?>
                    Mark Sent <input type="checkbox" name="status_chk" disabled="disabled" value="<?php echo DSS_CLAIM_SENT?>" checked="checked" />
                    <input type="hidden" name="status" value="<?php echo DSS_CLAIM_SENT?>" />
                <?php }elseif($status == DSS_CLAIM_SEC_REJECTED){ ?>
                    Mark Sent <input type="checkbox" name="status_chk" disabled="disabled" value="<?php echo DSS_CLAIM_SEC_SENT?>" checked="checked" />
                    <input type="hidden" name="status" value="<?php echo DSS_CLAIM_SEC_SENT?>" />
                <?php }else ?>
                <?php if (!$isSent) {  ?>
                    <input type="submit" name="ex_pagebtn" value="Print Claim"
                        <?php if($status == DSS_CLAIM_REJECTED || $status == DSS_CLAIM_SEC_REJECTED){ ?>
                            onclick="return confirm('This claim has been rejected. By printing this claim the status will be changed to SENT, and the rejection notification will be removed. Click OK to proceed.');"
                        <?php } ?>
                    />
                    <input type="button" name="elec" onclick="return change_form();" value="Switch to E-File" />
                    <input type="submit" name="elec_save" id="elec_save" style="display:none;" />
                <?php } ?>
            <?php } elseif ($_SESSION['user_type'] == DSS_USER_TYPE_SOFTWARE) { ?>
                <?php if(($isPending || $isDispute || $isRejected)){ ?>
                    Mark Sent <input type="checkbox" name="status_chk" disabled="disabled" value="<?php echo DSS_CLAIM_SENT?>" checked="checked" />
                    <input type="hidden" name="status" value="<?php echo DSS_CLAIM_SENT?>" />
                    <?php if (!$isSent) {  ?>
                        <input type="submit" name="ex_pagebtn" value="Print Claim" />
                        <?php
                        $api_sql = "SELECT use_eligible_api FROM dental_users WHERE userid='".$db->escape($_SESSION['docid'])."'";
                        $api_r = $db->getRow($api_sql);

                        if($api_r['use_eligible_api']==1){
                            if($isPending){
                                ?>
                                <input type="button" name="elec" onclick="return change_form();" value="Switch to E-File" />
                                <input type="submit" name="elec_save" id="elec_save" style="display:none;" />
                            <?php }elseif($isRejected || $isDispute){
                                ?>
                                <input type="button" name="elec" onclick="return change_form();" value="Switch to E-File" />
                                <?php
                            } ?>
                        <?php } ?>
                    <?php } ?>
                <?php } elseif(($status == DSS_CLAIM_SEC_PENDING || $status == DSS_CLAIM_SEC_REJECTED) && $s_m_dss_file == '2') { ?>
                    Mark Sent <input type="checkbox" name="status_chk" disabled="disabled" value="<?php echo DSS_CLAIM_SEC_SENT?>" checked="checked" />
                    <input type="hidden" name="status" value="<?php echo DSS_CLAIM_SEC_SENT?>" />
                    <?php if (!$isSent) {  ?>
                        <input type="submit" name="ex_pagebtn" value="Print Claim" />
                    <?php } ?>
                <?php } ?>
            <?php } ?>
            <?php if (!empty($is_back_office)) { ?>
                <input type="button" class="print-button" onclick="window.location='claim_notes.php?id=<?php echo  (!empty($_GET['insid']) ? $_GET['insid'] : ''); ?>&pid=<?php echo  $_GET['pid']; ?>'" value="View Notes" />
            <?php } ?>
            <?php if (!empty($is_front_office)) { ?>
                <p>
                    <input type="submit" name="preserve_status" value="Modify/Reprint Claim" title="This action WILL update the CMS-1500 form, but will NOT change claim status" onclick="return false;" />
                </p>
                <p>
                    <?php if ($fdf_file != '') { ?>
                        <a href="/manage/display_fdf_v2.php?f=<?= rawurlencode($fdf_file) ?>" class="print-button" title="This action will NOT update the CMS-1500 form">View Printed Claim</a>
                    <?php } else { ?>
                        <a href="/manage/insurance_fdf_v2.php?insid=<?= $claimId ?>&amp;pid=<?= $patientId ?>" class="print-button" title="This action will NOT update the CMS-1500 form">View Printed Claim</a>
                    <?php } ?>
                </p>
            <?php } ?>
        <?php } ?>
    </div>
    <?php if ($isRejected) { ?>
        <div class="rejected-banner">
            <?php if (isset($eligibleResponse['response'])) { ?>
                <h3>
                    <?= $eligibleResponse['event_type'] ?>
                    on
                    <?= $eligibleResponse['adddate'] ?>
                </h3>
                <p>
                    <strong>Reference ID:</strong>
                    <?= strlen($eligibleResponse['reference_id']) ? e($eligibleResponse['reference_id']) : '<i>Not set</i>' ?>
                </p>
                <?php if (is_object($eligibleResponse['response']->details)) { ?>
                    <p>
                        Category:
                        <?= $eligibleResponse['response']->details->codes->category_code ?>
                        -
                        <?= $eligibleResponse['response']->details->codes->category_label ?>
                        <br />
                        Status:
                        <?= $eligibleResponse['response']->details->codes->status_code ?>
                        -
                        <?= $eligibleResponse['response']->details->codes->status_label ?>
                    </p>
                <?php } elseif (is_array($eligibleResponse['response']->details) && $eligibleResponse['response']->details) { ?>
                    <ul>
                        <?php foreach ($eligibleResponse['response']->details as $each) { ?>
                            <li><?= e($each) ?></li>
                        <?php } ?>
                    </ul>
                <?php } ?>
            <?php } elseif (isset($eResponse['response'])) { ?>
                <h3>
                    Claim Electronically filed on
                    <?= $eResponse['adddate'] ?>
                </h3>
                <p>
                    <strong>Reference ID:</strong>
                    <?= strlen($eResponse['reference_id']) ? e($eResponse['reference_id']) : '<i>Not set</i>' ?>
                </p>
                <?php if ($eResponse['response']->success === 'true' || $eResponse['response']->success === true) { ?>
                    <p>
                        Success Response
                    </p>
                <?php } else { ?>
                    <p>Error response:</p>
                    <ul>
                        <?php foreach ($eResponse['response']->errors as $error) { ?>
                            <li><?= htmlspecialchars($error->message) ?></li>
                        <?php } ?>
                    </ul>
                <?php }
            } ?>
        </div>
        <?php
    }
    if (
        !empty($is_back_office) || (
            ($_SESSION['user_type'] == DSS_USER_TYPE_SOFTWARE) &&
            ($isPending || $isRejected) &&
            $p_m_dss_file == '2')
    ) { ?>
        <script type="text/javascript">
            $(document).ready(function(){
                setup_autocomplete_local(
                    'ins_payer_name',
                    'ins_payer_hints',
                    'p_m_eligible_payer',
                    '',
                    'https://eligible.com/resources/payers/claims/medical.json',
                    null,
                    null,
                    null,
                    true,
                    <?= json_encode($claimData['npi']) ?>,
                    '<?= $is_front_office ? 1 : 2 ?>'
                );
            });
        </script>
        <input type="hidden" name="p_m_eligible_payer" id="p_m_eligible_payer" value="<?php echo $p_m_eligible_payer_id."-".$p_m_eligible_payer_name;?>" />
        <?php
    }
    if (
        !empty($is_back_office) || (
            ($_SESSION['user_type'] == DSS_USER_TYPE_SOFTWARE) &&
            (
                !empty($isSecondaryPending) ||
                !empty($is_sec_rejected)
            ) &&
            $p_m_dss_file == '2'
        )
    ) { ?>
        <script type="text/javascript">
            $(document).ready(function(){
                setup_autocomplete_local(
                    's_m_ins_payer_name',
                    's_m_ins_payer_hints',
                    's_m_eligible_payer',
                    '',
                    'https://eligible.com/resources/payers/claims/medical.json',
                    null,
                    null,
                    null,
                    true,
                    <?= json_encode($claimData['npi']) ?>,
                    '<?= $is_front_office ? 1 : 2 ?>'
                );
            });
        </script>
        <input type="hidden" name="s_m_eligible_payer" id="s_m_eligible_payer" value="<?php echo $s_m_eligible_payer_id."-".$s_m_eligible_payer_name;?>" />
    <?php } ?>

    <table border="0" align="center" cellpadding="0" cellspacing="0" id="claim-form-table" class="eligibleapi claim">
        <tr>
            <td align="left" valign="top" width="50%">
                <span><div class="box_bg">1500</div></span>
                <span class="heading1">Health Insurance Claim Form</span><br />
                <span>Approved By National Uniform Claim Committee 08/05</span><br /><br />
                <span>
                    <input value="<?php echo (!empty($pica1) ? $pica1 : '');?>" name="pica1" type="text" readonly class="inbox_line1 grayout" maxlength="1"/>
                    <input value="<?php echo (!empty($pica2) ? $pica2 : '');?>" name="pica2" type="text" readonly class="inbox_line1 grayout" maxlength="1"/>
                    <input value="<?php echo (!empty($pica3) ? $pica3 : '');?>" name="pica3" type="text" readonly class="inbox_line1 grayout" maxlength="1"/>
                    PICA
                </span>
            </td>
            <td width="50%">
                <table>
                    <tr>
                        <td>Ins. Co:</td>
                        <td>
                            <?php echo $insuranceCompanyData['company']; ?>
                        </td>
                    </tr>
                    <tr>
                        <td valign="top">Address:</td>
                        <td valign="top">
                            <?php echo $insuranceCompanyData['add1']; ?><br />
                            <?php echo $insuranceCompanyData['add2']; ?>
                        </td>
                    </tr>
                    <tr>
                        <td> </td>
                        <td>
                            <?php echo $insuranceCompanyData['city']; ?>&nbsp;&nbsp;
                            <?php echo $insuranceCompanyData['state']; ?>&nbsp;,
                            <?php echo $insuranceCompanyData['zip']; ?><br />
                        </td>
                    </tr>
                </table>
                <br />
                <br />
            </td>
            <td align="left" valign="top">
                <span></span>
            </td>
        </tr>
        <tr>
            <td colspan="2" align="left" valign="top">
                <table width="1185" border="1" cellspacing="0" cellpadding="2">
                    <tr>
                        <td colspan="2" align="left" valign="top">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center" valign="top">
                                        <span class="num">1.</span>
                                        Medicare
                                    </td>
                                    <td align="center" valign="top">MediCaID</td>
                                    <td align="center" valign="top">Tricare Champus</td>
                                    <td align="center" valign="top">Chmapva</td>
                                    <td align="center" valign="top">Group Health Plan</td>
                                    <td align="center" valign="top">Feca blklung</td>
                                    <td align="center" valign="top">Other</td>
                                </tr>
                                <tr>
                                    <td align="left" valign="top">
                                        <input name="insurance_type" type="radio" value="1" <?php if($insurancetype == '1') {echo " checked";}?> />
                                        <span class="small_cap">(Medicare #)</span>
                                    </td>
                                    <td align="left" valign="top">
                                        <input name="insurance_type" type="radio" value="2" <?php if($insurancetype == '2') {echo " checked";}?> />
                                        <span class="small_cap">(Medicaid #)</span>
                                    </td>
                                    <td align="left" valign="top">
                                        <input name="insurance_type" type="radio" value="3" <?php if($insurancetype == '3') {echo " checked";}?> />
                                        <span class="small_cap">(Sponsor's SSN)</span>
                                    </td>
                                    <td align="left" valign="top">
                                        <input name="insurance_type" type="radio" value="4" <?php if($insurancetype == '4') {echo " checked";}?> />
                                        <span class="small_cap">(Member ID #)</span>
                                    </td>
                                    <td align="left" valign="top">
                                        <input name="insurance_type" type="radio" value="5" <?php if($insurancetype == '5') {echo " checked";}?> />
                                        <span class="small_cap">(SSN or ID)</span>
                                    </td>
                                    <td align="left" valign="top">
                                        <input name="insurance_type" type="radio" value="6" <?php if($insurancetype == '6') {echo " checked";}?> />
                                        <span class="small_cap">(SSN)</span>
                                    </td>
                                    <td align="left" valign="top">
                                        <input name="insurance_type" type="radio" value="7" <?php if($insurancetype == '7') {echo " checked";}?> />
                                        <span class="small_cap">(ID)</span>
                                    </td>
                                </tr>
                            </table>
                            <input type="hidden" name="other_insurance_type" value="<?php echo  $other_insurancetype; ?>" />
                        </td>
                        <td width="448" align="left" valign="top">
                            <span class="num_a">1a.</span>
                            Insured's ID Number
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            <span class="small_cap">(For Program in item 1)</span>
                            <br />
                            <input type="text" value="<?php echo $insured_id_number?>" name="insured_id_number" size="60" />
                            <input type="hidden" value="<?php echo $other_insured_id_number?>" name="other_insured_id_number" size="60" />
                        </td>
                    </tr>
                    <tr>
                        <td width="429" align="left" valign="top">
                            <span class="num">2.</span>
                            Patient Name
                            <span class="small_cap">(Last Name, First Name, Middle Initial)</span>
                            <br />
                            <div style="padding-top:7px;">
                                <input type="text" value="<?php echo $patient_lastname?>" name="patient_lastname" class="inbox_line3 inbox-third" size="18" width="60" />
                                &nbsp;
                                <input type="text" value="<?php echo $patient_firstname?>" name="patient_firstname" class="inbox_line3 inbox-third" size="18" />
                                &nbsp;
                                <input type="text" value="<?php echo $patient_middle?>" name="patient_middle" class="inbox_line3 inbox-third" size="3" width="30" />
                            </div>
                        </td>
                        <td width="300" align="left" valign="top">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td width="58%" align="left" valign="top">
                                        <span class="num">3.</span>
                                        Patient's Birth Date
                                        <br />
                                        &nbsp;&nbsp;
                                        <input id="dob" name="patient_dob" type="text" class="field text addr tbox calendar" value="<?php echo $patient_dob?>" style="width:100px;" maxlength="255" onChange="validateDate('dob');" placeholder="YYYY-MM-DD" data-date-format="Y-m-d" />
                                    </td>
                                    <td width="42%" align="center" valign="top">
                                        Sex
                                        <br />
                                        M
                                        <input type="radio" name="patient_sex" value="M" <?php if($patient_sex == "M" || $patient_sex == "Male") echo " checked";?> />
                                        &nbsp;&nbsp;F
                                        <input type="radio" name="patient_sex" value="F" <?php if($patient_sex == "F" || $patient_sex == "Female") echo " checked";?> />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td align="left" valign="top">
                            <span class="num">4.</span>
                            Insured's Name &nbsp;
                            <span class="small_cap">(Last Name, First Name, Middle Initial)</span>
                            <br />
                            <div style="padding-top:7px;">
                                <input type="text" value="<?php echo $insured_lastname?>" name="insured_lastname" class="inbox_line3 inbox-third" size="18" width="60" />
                                &nbsp;
                                <input type="text" value="<?php echo $insured_firstname?>" name="insured_firstname" class="inbox_line3 inbox-third" size="18" />
                                &nbsp;
                                <input type="text" value="<?php echo $insured_middle?>" name="insured_middle" class="inbox_line3  inbox-third" size="3" width="30" />
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td align="left" valign="top">
                            <span class="num">5.</span>
                            Patient's Address
                            <span class="small_cap">(No. Street)</span>
                            <br />
                            <input type="text" value="<?php echo $patient_address?>" name="patient_address" class="inbox_line3" size="28"  />
                        </td>
                        <td align="left" valign="top">
                            <span class="num">6.</span>
                            Patient Relationship To Insured
                            <table width="80%" border="0" align="center" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td align="left" valign="top">
                                        <span class="small_cap">Self</span>
                                        <input name="patient_relation_insured" type="radio" value="Self" <?php if($patient_relation_insured == "Self" || $patient_relation_insured=="") echo " checked";?> />
                                    </td>
                                    <td align="left" valign="top">
                                        <span class="small_cap">Spouse</span>
                                        <input name="patient_relation_insured" type="radio" value="Spouse" <?php if($patient_relation_insured == "Spouse") echo " checked";?> />
                                    </td>
                                    <td align="left" valign="top">
                                        <span class="small_cap">Child</span>
                                        <input name="patient_relation_insured" type="radio" value="Child" <?php if($patient_relation_insured == "Child") echo " checked";?> />
                                    </td>
                                    <td align="left" valign="top">
                                        <span class="small_cap">Others</span>
                                        <input name="patient_relation_insured" type="radio" value="Other" <?php if($patient_relation_insured == "Other") echo " checked";?> />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td align="left" valign="top">
                            <span class="num">7.</span>
                            Insured's Address
                            <span class="small_cap">(No. Street)</span>
                            <br />
                            <input value="<?php echo $insured_address?>" name="insured_address" type="text" class="inbox_line3" size="28" />
                        </td>
                    </tr>
                    <tr>
                        <td align="left" valign="top">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td width="115" align="left" valign="top">
                                        City<br />
                                        <input value="<?php echo $patient_city?>" name="patient_city" type="text" class="inbox_line3" size="28"/>
                                    </td>
                                    <td width="13" align="left" valign="top" class="b_line"></td>
                                    <td width="196" align="left" valign="top" style="padding-left:4px;">
                                        State<br />
                                        <input value="<?php echo $patient_state?>" name="patient_state" type="text" class="inbox_line3 statemask" size="3" width="30" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td rowspan="2" align="left" valign="top" class="grayout">
                            <span class="num">8.</span>
                            Reserved for NUCC Use<br />
                            <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td align="left" valign="top">
                                        <input name="nucc_8a" value="<?php echo  (!empty($nucc_8a) ? $nucc_8a : ''); ?>" type="text" />
                                        <input name="nucc_8b" value="<?php echo  (!empty($nucc_8b) ? $nucc_8b : ''); ?>" type="text" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td align="left" valign="top">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td width="115" align="left" valign="top">
                                        City<br />
                                        <input value="<?php echo $insured_city?>" name="insured_city" type="text" class="inbox_line3" size="28"/>
                                    </td>
                                    <td width="13" align="left" valign="top" class="b_line"></td>
                                    <td width="196" align="left" valign="top" style="padding-left:4px;">
                                        State<br />
                                        <input value="<?php echo $insured_state?>" name="insured_state" type="text" class="inbox_line3 statemask" size="3" width="30" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td align="left" valign="top">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td width="115" align="left" valign="top">
                                        Zip Code
                                        <br />
                                        <input value="<?php echo $patient_zip?>" name="patient_zip" type="text" class="inbox_line3" size="13"  />
                                    </td>
                                    <td width="13" align="left" valign="top" class="b_line"></td>
                                    <td width="196" align="left" valign="top" style="padding-left:4px;">
                                        Telephone
                                        <span class="small_cap">(Include Area Code)</span>
                                        <br />
                                        <span class="style1">
                                            (<input type="text" value="<?php echo  $patient_phone_code; ?>" name="patient_phone_code" size="3" class="inbox_line3 inbox-third phonecodemask" />)
                                        </span>
                                        &nbsp;&nbsp;&nbsp;
                                        <input type="text" value="<?php echo $patient_phone?>" name="patient_phone" class="inbox_line3 inbox-half phonemask" size="13"  />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td align="left" valign="top">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td width="115" align="left" valign="top">
                                        Zip Code
                                        <br />
                                        <input value="<?php echo $insured_zip?>" name="insured_zip" type="text" class="inbox_line3" size="13"  />
                                    </td>
                                    <td width="13" align="left" valign="top" class="b_line"></td>
                                    <td width="196" align="left" valign="top" style="padding-left:4px;">
                                        Telephone
                                        <span class="small_cap">(Include Area Code)</span>
                                        <br />
                                        <span class="style1">
                                            (<input type="text" value="<?php echo $insured_phone_code?>" name="insured_phone_code" size="3" class="inbox_line3 inbox-third phonecodemask" />)
                                        </span>
                                        &nbsp;&nbsp;&nbsp;
                                        <input type="text" value="<?php echo $insured_phone?>" name="insured_phone" class="inbox_line3 inbox-third phonemask" size="13" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td align="left" valign="top">
                            <span class="num">9.</span>
                            Other Insured's Name
                            <span class="small_cap">(Last Name, first, Middle Initial)</span>
                            <br />
                            <div style="padding-top:7px;">
                                <input type="text" value="<?php echo $other_insured_lastname?>" name="other_insured_lastname" class="inbox_line3 inbox-third" size="18" />
                                &nbsp;
                                <input type="text" value="<?php echo $other_insured_firstname?>" name="other_insured_firstname" class="inbox_line3 inbox-third" size="18" width="60" />
                                &nbsp;
                                <input type="text" value="<?php echo $other_insured_middle?>" name="other_insured_middle" class="inbox_line3 inbox-third" size="3" width="30" />
                            </div>
                        </td>
                        <td rowspan="4" align="left" valign="top">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="left" valign="top" style="line-height:33px;">
                                        <span class="num">10.</span>
                                        Is patient's Condition Related To :
                                    </td>
                                </tr>
                                <tr>
                                    <td align="left" valign="top" style="line-height:25px;">
                                        <span class="num_a">a.</span>
                                        Employment?
                                        <span class="small_cap">(current Or Previous)</span>
                                        <br />
                                        <input type="radio" name="employment" value="YES" <?= isOptionSelected($employment) ? 'checked' : '' ?> />
                                        Yes
                                        &nbsp;&nbsp;
                                        <input type="radio" name="employment" value="NO" <?= isOptionSelected($employment) ? '' : 'checked' ?> />
                                        NO
                                    </td>
                                </tr>
                                <tr>
                                    <td align="left" valign="top" style="line-height:25px;">
                                        <span class="num_a">b.</span>
                                        Auto Accident?
                                        <br />
                                        <input type="radio" name="auto_accident" value="YES" <?= isOptionSelected($auto_accident) ? 'checked' : '' ?> />
                                        Yes
                                        &nbsp;&nbsp;
                                        <input type="radio" name="auto_accident" value="NO" <?= isOptionSelected($auto_accident) ? '' : 'checked' ?> />
                                        NO
                                        &nbsp;&nbsp;
                                        Place <span class="small_cap">(State)</span>
                                        <input type="text" value="<?php echo (!empty($auto_accident_place) ? $auto_accident_place : '')?>" class="inbox_line3 inbox-third" size="10" name="auto_accident_place" />
                                    </td>
                                </tr>
                                <tr>
                                    <td align="left" valign="top" style="line-height:25px;">
                                        <span class="num_a">c.</span>
                                        Other Accident?
                                        <br />
                                        <input type="radio" name="other_accident" value="YES" <?= isOptionSelected($other_accident) ? 'checked' : '' ?> />
                                        Yes
                                        &nbsp;&nbsp;
                                        <input type="radio" name="other_accident" value="NO" <?= isOptionSelected($other_accident) ? '' : 'checked' ?> />
                                        NO
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td align="left" valign="top">
                            <span class="num">11.</span>
                            Insured's Policy Group or FECA Number
                            <br />
                            <input value="<?php echo $insured_policy_group_feca?>" name="insured_policy_group_feca" type="text" class="inbox_line3" size="28"/>
                        </td>
                    </tr>
                    <tr>
                        <td align="left" valign="top">
                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td>
                                        <span class="num_a">a1.</span>
                                        Other Insured's policy Or Group Number
                                        <br />
                                        <input value="<?= $other_insured_policy_group_feca ?>" name="other_insured_policy_group_feca" type="text" class="inbox_line3" size="28" />
                                    </td>
                                    <td>
                                        <span class="num_a">a2.</span>
                                        Relationship
                                        <br />
                                        <select name="patient_relation_other_insured">
                                            <option value=""></option>
                                            <?php foreach ($otherRelationships as $code=>$label) { ?>
                                                <option value="<?= e($code) ?>"
                                                    <?= in_array($patient_relation_other_insured, [$code, $label]) ?' selected' : '' ?>>
                                                    <?= e($label) ?>
                                                </option>
                                            <?php } ?>
                                        </select>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td align="left" valign="top">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td width="58%" align="left" valign="top">
                                        <span class="num_a">a.</span>
                                        Insured's Birth Date
                                        <br />
                                        &nbsp;&nbsp;
                                        <input id="insured_dob" name="insured_dob" type="text" class="field text addr tbox calendar" value="<?php echo  $insured_dob; ?>" style="width:100px;" maxlength="255" onChange="validateDate('insured_dob');" placeholder="YYYY-MM-DD" data-date-format="Y-m-d" />
                                    </td>
                                    <td width="42%" align="center" valign="top">
                                        Sex
                                        <br />
                                        M
                                        <input type="radio" name="insured_sex" value="M" <?php if($insured_sex == "M" || $insured_sex == "Male") echo " checked";?> />
                                        &nbsp;&nbsp;F
                                        <input type="radio" name="insured_sex" value="F" <?php if($insured_sex == "F" || $insured_sex == "Female") echo " checked";?> />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td align="left" valign="top" class="grayout">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="left" valign="top">
                                        <span class="num_a">b.</span>
                                        Reserved for NUCC Use
                                        <br />
                                        <input type="text" name="nucc_9b" value="<?php echo  (!empty($nucc_9b) ? $nucc_9b : ''); ?>" class="inbox_line3" size="28"/>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td align="left" valign="top" class="grayout">
                            <span class="num_a">b.</span>
                            Other Claim ID (Designated by NUCC)
                            <br />
                            <input name="other_claim_id" value="<?php echo  (!empty($other_claim_id) ? $other_claim_id : ''); ?>" type="text" class="inbox_line3" size="28"  />
                        </td>
                    </tr>
                    <tr>
                        <td align="left" valign="top" class="grayout">
                            <span class="num_a">c.</span>
                            Reserved for NUCC Use
                            <br />
                            <input name="nucc_9c" value="<?php echo  (!empty($nucc_9c) ? $nucc_9c : ''); ?>" type="text" class="inbox_line3" size="28"  />
                        </td>
                        <td align="left" valign="top">
                            <span class="num_a">c.</span>
                            Insurance Plan Name or Program Name
                            <br />
                            <input value="<?php echo $insured_insurance_plan?>" name="insured_insurance_plan" type="text" class="inbox_line3" size="28"  />
                        </td>
                    </tr>
                    <tr>
                        <td align="left" valign="top">
                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td>
                                        <span class="num_a">d.</span>
                                        Insurance Plan Name or Program Name
                                        <br />
                                        <input value="<?php echo $other_insured_insurance_plan?>" type="text" class="inbox_line3" size="28" name="other_insured_insurance_plan" />
                                    </td>
                                    <td>
                                        <span class="num_a">e.</span>
                                        Res. sequence
                                        <br />
                                        <select name="responsibility_sequence">
                                            <option value=""></option>
                                            <option value="P" <?= $responsibility_sequence === 'P' ? 'selected' : '' ?>>Primary</option>
                                            <option value="S" <?= $responsibility_sequence === 'S' ? 'selected' : '' ?>>Secondary</option>
                                            <option value="T" <?= $responsibility_sequence === 'T' ? 'selected' : '' ?>>Tertiary</option>
                                        </select>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td align="left" valign="top">
                            <span class="num_a">10d.</span>
                            Claim Codes (Designated by NUCC)
                            <br />
                            <input value="<?php echo (!empty($claim_codes) ? $claim_codes : ''); ?>" name="claim_codes" type="text" class="inbox_line3" size="28"  />
                        </td>
                        <td align="left" valign="top">
                            <span class="num_a">d.</span>
                            Is there another health benefit Plan?
                            <br />
                            <input type="radio" name="another_plan" value="yes" <?= isOptionSelected($another_plan) ? 'checked' : ''?> />YES
                            &nbsp;&nbsp;&nbsp;
                            <input type="radio" name="another_plan" value="no" <?= !isOptionSelected($another_plan) ? 'checked' : '' ?> />NO
                            &nbsp;&nbsp;
                            <span class="small_cap"><i>if yes, return to and complete item 9 a-d</i></span>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" align="left" valign="top">
                            <center style="text-align:center; font-weight:bold">
                                Read Back of Form Before Completing & Signing This Form
                            </center>
                            <span class="num">12.</span>
                            Patient's or Authorized Person's Signature
                            <span class="small_cap"> I authorize the release of any medical or other information neccessary to process this claim. I also reuest payment of government benefits either to myself or th the party who accepts assignment below.</span>
                            <br /><br /><br />
                            <input type="checkbox" name="patient_signature" value="1" <?php if($patient_signature == "1" || $patient_signature == "Y") echo " checked";?> />
                            Signature on File
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            Date:
                            <input id="patient_signed_date" name="patient_signed_date" type="text" class="field text addr tbox calendar" value="<?php echo $patient_signed_date?>" style="width:100px;" maxlength="255" onChange="validateDate('patient_signed_date');" placeholder="YYYY-MM-DD" data-date-format="Y-m-d" />
                        </td>
                        <td align="left" valign="top">
                            <span class="num">13.</span>
                            Insured's or Authorized person's Signature
                            <span class="small_cap"> I authorize payment of medical benefits to the undersigned physician or supplier for services described below</span>
                            <br /><br /><br />
                            <?php
                            echo "<center>SIGNATURE ON FILE: <input type='checkbox' name='insured_signature' value='1' ";
                            if($insured_signature){
                                echo "checked";
                            }
                            echo " /></center>"; ?>
                        </td>
                    </tr>
                    <tr>
                        <td valign="top">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td width="58%" align="left" valign="top">
                                        <span class="num">14.</span>
                                        DATE OF CURRENT ILLNESS, INJURY, or PREGNANCY (LMP)
                                        <br />
                                        &nbsp;&nbsp;
                                        <input id="date_current" name="date_current" type="text" class="field text addr tbox calendar" value="<?php echo $date_current?>" style="width:100px;" maxlength="255" onChange="validateDate('date_current');" placeholder="YYYY-MM-DD" data-date-format="Y-m-d" />
                                        <span class="small_cap"> QUAL. </span>
                                        <input type="text" name="current_qual" class="inbox_line3 inbox-third" value="<?php echo (!empty($current_qual) ? $current_qual : ''); ?>" size="10"/>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td valign="top" class="grayout">
                            <span class="num">15.</span>
                            Other Date
                            <br />
                            <span class="small_cap">QUAL.</span>
                            <input type="text" name="same_illness_qual" class="inbox_line3 inbox-third" size="10" value="<?php echo (!empty($same_illness_qual) ? $same_illness_qual : ''); ?>"/>
                            &nbsp;&nbsp;
                            <input id="date_same_illness" name="date_same_illness" type="text" class="field text addr tbox calendar" value="<?php echo $date_same_illness?>" style="width:100px;" maxlength="255" onChange="validateDate('date_same_illness');" placeholder="YYYY-MM-DD" data-date-format="Y-m-d" />
                        </td>
                        <td valign="top">
                            <span class="num">16.</span>
                            Dates Patient unable to work in Current Occupation
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td valign="middle" width="10%">
                                        From
                                    </td>
                                    <td valign="top" width="40%">
                                        &nbsp;&nbsp;
                                        <input id="unable_date_from" name="unable_date_from" type="text" class="field text addr tbox calendar" value="<?php echo (!empty($unable_date_from) ? $unable_date_from : ''); ?>" style="width:100px;" maxlength="255" onChange="validateDate('unable_date_from');" placeholder="YYYY-MM-DD" data-date-format="Y-m-d" />
                                    </td>
                                    <td valign="middle" align="right" width="10%">
                                        To
                                    </td>
                                    <td valign="top" width="40%">
                                        &nbsp;&nbsp;
                                        <input id="unable_date_to" name="unable_date_to" type="text" class="field text addr tbox calendar" value="<?php echo (!empty($unable_date_to) ? $unable_date_to : ''); ?>" style="width:100px;" maxlength="255" onChange="validateDate('unable_date_to');" placeholder="YYYY-MM-DD" data-date-format="Y-m-d" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td valign="top">
                            <span class="num">17.</span>
                            Name of Referring Provider or Other Source
                            <select name="name_referring_provider_qualifier">
                                <option value=""></option>
                                <option value="DN_CLAIM" <?= $name_referring_provider_qualifier == 'DN_CLAIM' ? 'selected' : '' ?>>
                                    DN - Referring Provider (Claim level)
                                </option>
                                <option value="DN" <?= $name_referring_provider_qualifier == 'DN' ? 'selected' : '' ?>>
                                    DN - Referring Provider
                                </option>
                                <option value="DN_DME" <?= $name_referring_provider_qualifier == 'DN_DME' ? 'selected' : '' ?>>
                                    DN-DME - Referring Provider For DME Service Line 1
                                </option>
                                <option value="DK" <?= $name_referring_provider_qualifier == 'DK' ? 'selected' : '' ?>>
                                    DK - Ordering Provider
                                </option>
                                <option value="DQ" <?= $name_referring_provider_qualifier == 'DQ' ? 'selected' : '' ?>>
                                    DQ - Supervising Provider
                                </option>
                            </select>
                            <input type="text" value="<?php echo  $referring_provider; ?>" name="referring_provider" class="inbox_line3" size="20" />
                        </td>
                        <td valign="top">
                            <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td valign="top" width="10%" style="border-bottom: 1px #000000 dashed;">
                                        <span class="num">17<span class="num_a">a.</span></span>
                                    </td>
                                    <td valign="top" width="10%" style="border-bottom: 1px #000000 dashed;">
                                        <select name="field_17a_dd" class="inbox_line3" style="width:40px;">
                                            <option value=""></option>
                                            <option value="0B" <?= $field_17a_dd == '0B' ? 'selected' : '' ?>>State License Number</option>
                                            <option value="1G" <?= $field_17a_dd == '1G' ? 'selected' : '' ?>>Provider UPIN Number</option>
                                            <option value="G2" <?= $field_17a_dd == 'G2' ? 'selected' : '' ?>>Provider Commercial Number</option>
                                        </select>
                                    </td>
                                    <td valign="top" width="80%" style="border-bottom: 1px #000000 dashed; padding-bottom:3px;">
                                        <input type="text" value="<?php echo (!empty($field_17a) ? $field_17a : ''); ?>" name="field_17a" class="inbox_line3" size="30"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td valign="top">
                                        <span class="num">17<span class="num_a">b.</span>
                                    <td valign="top">
                                        NPI
                                    </td>
                                    <td valign="top" style="padding-top:3px;">
                                        <input type="text" value="<?php echo  $diagnosising_npi; ?>" name="field_17b" class="inbox_line3" size="30"/>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td valign="top">
                            <span class="num">18.</span>
                            Hospitalization Dates Related to Current Services
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td valign="middle" width="10%">
                                        From
                                    </td>
                                    <td valign="top" width="40%">
                                        &nbsp;&nbsp;
                                        <input id="hospitalization_date_from" name="hospitalization_date_from" type="text" class="field text addr tbox calendar" value="<?php echo (!empty($hospitalization_date_from) ? $hospitalization_date_from : ''); ?>" style="width:100px;" maxlength="255" onChange="validateDate('hospitalization_date_from');" placeholder="YYYY-MM-DD" data-date-format="Y-m-d" />
                                    </td>
                                    <td valign="middle" align="right" width="10%">To</td>
                                    <td valign="top" width="40%">
                                        &nbsp;&nbsp;
                                        <input id="hospitalization_date_to" name="hospitalization_date_to" type="text" class="field text addr tbox calendar" value="<?php echo (!empty($hospitalization_date_to) ? $hospitalization_date_to : ''); ?>" style="width:100px;" maxlength="255" onChange="validateDate('hospitalization_date_to');" placeholder="YYYY-MM-DD" data-date-format="Y-m-d" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td valign="top" colspan="2">
                            <span class="num">19.</span>
                            Additional Claim Information (DESIGNATED BY NUCC)<br />
                            <input type="text" value="<?php echo (!empty($reserved_local_use1) ? $reserved_local_use1 : '')?>" name="reserved_local_use1" class="inbox_line3" size="100" />
                        </td>
                        <td valign="top">
                            <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td valign="top" width="60%">
                                        <span class="num">20.</span>
                                        Outside Lab?
                                        <br />
                                        <input type="radio" name="outside_lab" value="YES"  <?= isOptionSelected($outside_lab) ? 'checked' : ''?>/>
                                        YES
                                        &nbsp;&nbsp;
                                        <input type="radio" name="outside_lab" value="NO" <?= !isOptionSelected($outside_lab) ? 'checked' : '' ?> />
                                        NO
                                    </td>
                                    <td valign="top" width="40%">
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        S Charges
                                        <br />
                                        <input type="text" value="<?php echo (!empty($s_charges) ? $s_charges : ''); ?>" name="s_charges" class="inbox_line3" size="30" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td valign="top" colspan="2" rowspan="2">
                            <span class="num">21.</span>
                            Diagnosis or Nature of Illness or Injury
                            <span class="small_cap">
                                (Relate A-L to service line below (24E))
                            </span>
                            ICD IND.
                            <select name="icd_ind" class="inbox-wide">
                                <option value="9" <?= $icd_ind == 9 ? 'selected="selected"' : '' ?>>
                                    ICD-9-CM - 9
                                </option>
                                <option value="0" <?= $icd_ind == 0 || $icd_ind == 10 ? 'selected="selected"' : '' ?>>
                                    ICD-10-CM - 0
                                </option>
                            </select>
                            <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td valign="top" width="23%">
                                        <b>A.</b>
                                        <input type="text" name="diagnosis_a" class="inbox_line3" size="20" value="<?php echo  $diagnosis_a; ?>" />
                                    </td>
                                    <td valign="top" width="23%">
                                        <b>B.</b>
                                        <input type="text" name="diagnosis_b" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_b) ? $diagnosis_b : ''); ?>" />
                                    </td>
                                    <td valign="top" width="23%">
                                        <b>C.</b>
                                        <input type="text" name="diagnosis_c" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_c) ? $diagnosis_c : ''); ?>" />
                                    </td>
                                    <td valign="top" width="23%">
                                        <b>D.</b>
                                        <input type="text" name="diagnosis_d" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_d) ? $diagnosis_d : ''); ?>" />
                                    </td>
                                </tr>
                                <tr>
                                    <td valign="top" width="23%">
                                        <b>E.</b>
                                        <input type="text" name="diagnosis_e" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_e) ? $diagnosis_e : ''); ?>" />
                                    </td>
                                    <td valign="top" width="23%">
                                        <b>F.</b>
                                        <input type="text" name="diagnosis_f" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_f) ? $diagnosis_f : ''); ?>" />
                                    </td>
                                    <td valign="top" width="23%">
                                        <b>G.</b>
                                        <input type="text" name="diagnosis_g" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_g) ? $diagnosis_g : ''); ?>" />
                                    </td>
                                    <td valign="top" width="23%">
                                        <b>H.</b>
                                        <input type="text" name="diagnosis_h" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_h) ? $diagnosis_h : ''); ?>" />
                                    </td>
                                </tr>
                                <tr>
                                    <td valign="top" width="23%">
                                        <b>I.</b>
                                        <input type="text" name="diagnosis_i" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_i) ? $diagnosis_i : ''); ?>" />
                                    </td>
                                    <td valign="top" width="23%">
                                        <b>J.</b>
                                        <input type="text" name="diagnosis_j" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_j) ? $diagnosis_j : ''); ?>" />
                                    </td>
                                    <td valign="top" width="23%">
                                        <b>K.</b>
                                        <input type="text" name="diagnosis_k" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_k) ? $diagnosis_k : ''); ?>" />
                                    </td>
                                    <td valign="top" width="23%">
                                        <b>L.</b>
                                        <input type="text" name="diagnosis_l" class="inbox_line3" size="20" value="<?php echo  (!empty($diagnosis_l) ? $diagnosis_l : ''); ?>" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td valign="top">
                            <table width="100%" cellspacing="0" cellpadding="0" border="0">
                                <tr>
                                    <td width="60%">
                                        <span class="num">22.</span>
                                        Resubmission Code
                                        <br>
                                        <label class="small_cap">
                                            <input type="radio" name="resubmission_code_fill" value="1" <?= $resubmission_code_fill == 1 ? 'checked' : '' ?> />
                                            Original
                                        </label>
                                        <label class="small_cap">
                                            <input type="radio" name="resubmission_code_fill" value="7" <?= $resubmission_code_fill == 7 ? 'checked' : '' ?> />
                                            Resubmission
                                        </label>
                                        <label class="small_cap">
                                            <input type="radio" name="resubmission_code_fill" value="8" <?= $resubmission_code_fill == 8 ? 'checked' : '' ?> />
                                            Cancellation
                                        </label>
                                    </td>
                                    <td width="40%">
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        Original Ref. No.
                                        <input type="text" value="<?= $original_ref_no ?>" name="original_ref_no" class="inbox_line3" size="30" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td valign="top">
                            <span class="num">23.</span>
                            Prior Authorization Number
                            <br />
                            <input type="text" value="<?php echo $prior_authorization_number?>" name="prior_authorization_number" class="inbox_line3" size="60" />
                        </td>
                    </tr>
                    <!-- START BOX 24 -->
                    <tr>
                        <td valign="top" colspan="3" class="vertical-center">
                            <a name="procedure"></a>
                            <span class="num">24.</span>
                            <table width="100%" cellpadding="3" cellspacing="1" border="0" bgcolor="#000000" >
                                <tr bgcolor="#FFFFFF">
                                    <td valign="top" colspan="2" align="center">
                                        <span class="num_a">A.</span>
                                        Date(s) of service
                                    </td>
                                    <td valign="top" align="center">
                                        <span class="num_a">B.</span>
                                    </td>
                                    <td valign="top" align="center">
                                        <span class="num_a">C.</span>
                                    </td>
                                    <td valign="top" colspan="2" width="240" align="center">
                                        <span class="num_a">D.</span>
                                        Procedures, Services or Supplies
                                        <br />
                                        <span class="small_cap">
                                            (Explain Unusual Circumstances)
                                        </span>
                                    </td>
                                    <td valign="top" align="center">
                                        <span class="num_a">E.</span>
                                    </td>
                                    <td valign="top" align="center">
                                        <span class="num_a">F.</span>
                                    </td>
                                    <td valign="top" align="center">
                                        <span class="num_a">G.</span>
                                    </td>
                                    <td valign="top" align="center">
                                        <span class="num_a">H.</span>
                                    </td>
                                    <td valign="top" align="center">
                                        <span class="num_a">I.</span>
                                    </td>
                                    <td valign="top" align="center">
                                        <span class="num_a">J.</span>
                                    </td>
                                </tr>
                                <tr bgcolor="#FFFFFF">
                                    <td valign="bottom" align="center">
                                        <span class="small_cap">
                                            From
                                            <br />
                                            MM
                                            &nbsp;&nbsp;&nbsp;
                                            DD
                                            &nbsp;&nbsp;&nbsp;
                                            YY
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center">
                                        <span class="small_cap">
                                            To
                                            <br />
                                            MM
                                            &nbsp;&nbsp;&nbsp;
                                            DD
                                            &nbsp;&nbsp;&nbsp;
                                            YY
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center">
                                        <span class="small_cap">
                                            PLACE OF <br />SERVICE
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center">
                                        <span class="small_cap">
                                            EMG
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center" width="80">
                                        <span class="small_cap">
                                            CPT/HCPCS
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center">
                                        <span class="small_cap">
                                            MODIFIER
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center" width="160">
                                        <span class="small_cap">
                                            DIAGNOSIS <br />POINTER
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center">
                                        <span class="small_cap">
                                            $ CHARGES
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center" width="48">
                                        <span class="small_cap">
                                            DAYS <br />OR <br />UNITS
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center" width="48">
                                        <span class="small_cap">
                                            EPSDT <br />Family <br />Plan
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center" width="48">
                                        <span class="small_cap">
                                            ID. <br />QUAL.
                                        </span>
                                    </td>
                                    <td valign="bottom" align="center" width="100">
                                        <span class="small_cap">
                                            RENDERING <br />PROVIDER ID. #
                                        </span>
                                    </td>
                                </tr>
                            </table>
                            <!-- START LEDGER TRXNS -->
                            <?php if (!count($transactions)) { ?>
                                <p style="text-align: center;"><strong>There are currently no ledger entries to be submitted.</strong></p>
                            <?php } ?>
                            <table width="100%">
                                <colgroup>
                                    <col width="102" />
                                    <col width="102" />
                                    <col width="60" />
                                    <col width="30" />
                                    <col width="80" />
                                    <col width="200" />
                                    <col width="160" />
                                    <col width="76" />
                                    <col width="48" />
                                    <col width="48" />
                                    <col width="48" />
                                    <col width="100" />
                                </colgroup>
                                <?php foreach ($transactions as $li => $array) { ?>
                                    <tr>
                                        <td>
                                            <input type="text" name="service_lines[<?= $li ?>][service_date_from]" value="<?= dateFormat($array['service_date']) ?>" />
                                        </td>
                                        <td>
                                            <input type="text" name="service_lines[<?= $li ?>][service_date_to]" value="<?= dateFormat($array['service_date']) ?>" />
                                        </td>
                                        <td>
                                            <select style="width:76px" name="service_lines[<?= $li ?>][place_of_service]">
                                                <option value=''>Select One</option>
                                                <?php
                                                $pos = ($array['placeofservice'] != '') ? $array['placeofservice'] : $array['place'];
                                                $dp = ($array['diagnosis_code_pointers'] != '') ? explode(',', $array['diagnosis_code_pointers']) : [1];
                                                if (!empty($placeServices)) {
                                                    foreach ($placeServices as $psr) { ?>
                                                        <option value="<?= $psr['place_service'] ?>" <?= $pos == $psr['place_service'] ? 'selected' : '' ?>>
                                                            <?= e($psr['place_service'] . '-' . $psr['description']) ?>
                                                        </option>
                                                    <?php }
                                                } ?>
                                            </select>
                                        </td>
                                        <td>
                                            <input style="width:26px;" type="checkbox" name="service_lines[<?= $li ?>][emergency]" value="true" <?= isOptionSelected($array['emg']) ? 'checked' : '' ?> />
                                        </td>
                                        <td>
                                            <select name="service_lines[<?= $li ?>][procedure_code]" style="width:100%">
                                                <?php
                                                foreach ($transactionCodes as $code) {
                                                    $description = $code['transaction_code'] . ($code['description'] ? ' - ' . $code['description'] : '');
                                                    $options = [$code['transaction_code'], $code['description'], $description];
                                                    $selected = (strlen($array['transaction_code']) && in_array($array['transaction_code'], $options)) || (strlen($array['description']) && in_array($array['description'], $options));
                                                    ?>
                                                    <option value="<?= $code['transaction_code'] ?>" <?= $selected ? 'selected' : '' ?>>
                                                        <?= e($description) ?>
                                                    </option>
                                                <?php } ?>
                                            </select>
                                        </td>
                                        <td class="text-center">
                                            <?php for ($n = 0; $n < 4; $n++) { ?>
                                                <select name="service_lines[<?= $li ?>][procedure_modifiers][<?= $n ?>]" style="width:171px;">
                                                    <option value=''>Select One</option>
                                                    <?php
                                                    for ($i = 0; $i < count($modifierCodes); $i++) {
                                                        $selected = ($array['modcode' . ($n ? $n + 1 : '')] == $modifierCodes[$i]['modifier_code']) ? 'selected' : ''; ?>
                                                        <option value="<?= $modifierCodes[$i]['modifier_code'] ?>" <?= $selected ?>>
                                                            <?= e($modifierCodes[$i]['modifier_code'] . ' ' . $modifierCodes[$i]['description']) ?>
                                                        </option>
                                                    <?php } ?>
                                                </select>
                                            <?php } ?>
                                        </td>
                                        <td>
                                            <table class="eligibleapi claim">
                                                <tbody>
                                                <tr class="eligibleapi claim">
                                                    <?php for ($n=0; $n<12; $n++) { ?>
                                                        <?php if ($n && !($n%4)) { ?></tr><tr class="eligibleapi claim"><?php } ?>
                                                        <td class="input-center-hint checkbox-container">
                                                            <input class="input" value="<?= $n + 1 ?>" <?= in_array($n + 1, $dp) ? 'checked' : '' ?> name="service_lines[<?= $li ?>][diagnosis_code_pointers][<?= $n ?>]" type="checkbox">
                                                        </td>
                                                        <td class="input-side-hint"><?= chr(65 + $n) ?></td>
                                                    <?php } ?>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                        <td align="right" style="padding-right:15px;">
                                            <input type="text" name="service_lines[<?= $li ?>][charge_amount]" value="<?= number_format($array['amount'], 2) ?>" />
                                        </td>
                                        <td>
                                            <input style="width:39px;" type="text" name="service_lines[<?= $li ?>][units]" value="<?php echo $array['daysorunits']; ?>">
                                        </td>
                                        <td>
                                            <input style="width:45px;" type="text" name="service_lines[<?= $li ?>][epsdt]" value="<?php echo $array['epsdt']; ?>">
                                        </td>
                                        <td>
                                           <input style="width:37px;" type="text" name="service_lines[<?= $li ?>][qualifier]" value="<?php echo $array['idqual']; ?>">
                                        </td>
                                        <td>
                                            <input type="text" name="service_lines[<?= $li ?>][rendering_provider][npi]" value="<?= $array['provider_id'] ?>" />
                                            <input type="hidden" name="service_lines[<?= $li ?>][ledger_id]" value="<?= $array['ledgerid'] ?>" />
                                            <input type="hidden" name="service_lines[<?= $li ?>][verification]" value="<?= e($array['verification']) ?>" />
                                        </td>
                                    </tr>
                                <?php } ?>
                                <?php for ($li = count($transactions); $li < 6; $li++) { ?>
                                    <tr class="grayout">
                                        <td>
                                            <input type="text" disabled />
                                        </td>
                                        <td>
                                            <input type="text" disabled />
                                        </td>
                                        <td>
                                            <select style="width:76px" disabled></select>
                                        </td>
                                        <td>
                                            <input style="width:26px;" type="checkbox" disabled />
                                        </td>
                                        <td>
                                            <input type="text" disabled />
                                        </td>
                                        <td class="text-center">
                                            <select style="width:171px;" disabled></select>
                                            <select style="width:171px;" disabled></select>
                                            <select style="width:171px;" disabled></select>
                                            <select style="width:171px;" disabled></select>
                                        </td>
                                        <td>
                                            <table class="eligibleapi claim">
                                                <tbody>
                                                    <tr class="eligibleapi claim">
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">A</td>
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">B</td>
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">C</td>
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">D</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">E</td>
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">F</td>
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">G</td>
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">H</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="input-center-hintIcheckbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">I</td>
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">J</td>
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">K</td>
                                                        <td class="input-center-hint checkbox-container"><input class="input" type="checkbox" disabled /></td>
                                                        <td class="input-side-hint">L</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </td>
                                        <td style="padding-right:15px;">
                                            <input type="text" disabled />
                                        </td>
                                        <td>
                                            <input style="width:39px;" type="text" disabled />
                                        </td>
                                        <td>
                                            <input style="width:45px;" type="text" disabled />
                                        </td>
                                        <td>
                                            <input style="width:37px;" type="text" disabled />
                                        </td>
                                        <td>
                                            <input type="text" disabled />
                                        </td>
                                    </tr>
                                <?php } ?>
                            </table>
                            <!-- /END LEDGER TRXNS -->
                        </td>
                    </tr>
                    <!-- /END BOX 24 -->
                    <tr>
                        <td valign="top" colspan="2" height="100%">
                            <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td valign="top" width="40%">
                                        <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                            <tr>
                                                <td valign="top" width="80%">
                                                    <span class="num">25.</span>
                                                    Federal Tax I.D.Number
                                                    <br />
                                                    <input type="text" value="<?= $federal_tax_id_number ?>"
                                                        name="federal_tax_id_number" size="20" class="inbox_line3" />
                                                </td>
                                                <td valign="top" width="10%" align="center">
                                                    SSN
                                                    <br />
                                                    <input type="radio" name="ssnein" value="ssn" <?php if($ssn == "1") echo " checked";?> />
                                                </td>
                                                <td valign="top" width="10%" align="center">
                                                    EIN
                                                    <br />
                                                    <input type="radio" name="ssnein" value="ein" <?php if($ein == "1") echo " checked";?> />
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    <td class="b_line label grayout" align="left" valign="top" width="13"></td>
                                    <td valign="top" width="30%" class="grayout">
                                        <span class="num">26.</span>
                                        Patient Account No.
                                        <br />
                                        <input type="text" value="<?php echo (!empty($patient_account_no) ? $patient_account_no : ''); ?>" name="patient_account_no" class="inbox_line3" size="20" />
                                    </td>
                                    <td class="b_line label" align="left" valign="top" width="13"></td>
                                    <td valign="top" width="30%">
                                        <span class="num">27.</span>
                                        Accept Assignment?
                                        <br />
                                        <span class="small_cap">(For govt. claims, see back)</span>
                                        <br />
                                        <input type="radio" name="accept_assignment" value="Yes" <?= $acceptAssignment ? 'checked' : '' ?> />
                                        YES
                                        &nbsp;&nbsp;&nbsp;
                                        <input type="radio" name="accept_assignment" value="No" <?= !$acceptAssignment ? 'checked' : '' ?> />
                                        NO
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td valign="top" colspan="2" height="100%">
                            <!-- START DOLLAR BOXES 28,29,30 -->
                            <table width="100%" cellpadding="1" cellspacing="1" border="0">
                                <tr>
                                    <td valign="top" width="33%">
                                        <span class="num">28.</span> Total Charge<br/>
                                        $ <input type="text" value="<?php echo $total_charge;?>" name="total_charge" class="inbox_line3 number_field" size="15" />
                                    </td>
                                    <td class="b_line label" align="left" valign="top" width="13"></td>
                                    <td valign="top" width="33%">
                                        <span class="num">29.</span> Amount Paid<br/>
                                        $ <input type="text" value="<?php echo $amount_paid;?>" name="amount_paid" class="inbox_line3 number_field" size="15"/>
                                    </td>
                                    <td class="b_line label grayout" align="left" valign="top" width="13"></td>
                                    <td valign="top" width="33%" class="grayout">
                                        <span class="num">30.</span> RSVD for NUCC Use<br/>
                                        <input type="text" name="nucc_30" value="<?php echo  (!empty($nucc_30) ? $nucc_30 : ''); ?>" class="inbox_line3 " size="15" />
                                        <br/>
                                        <span class="small_cap">&nbsp;</span>
                                    </td>
                                </tr>
                            </table>
                            <!-- END DOLLAR BOXES 28,29,30 -->
                        </td>
                    </tr>
                    <tr>
                        <td valign="top" colspan="2" height="100%">
                            <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td valign="top" width="50%">
                                        <span class="num">31.</span>
                                        Signature of Physician or Supplier Including Degrees or Credentals
                                        <span class="small_cap">
                                            (I certify that the statements on the reverse apply to this bill and are made a part thereof.)
                                        </span>
                                        <br /><br />
                                        <input type="text" class="inbox_line3 grayout" size="40" disabled />
                                        <input type="hidden" name="signature_physician" value="<?= $signature_physician ?>" />
                                        <br /><br />
                                        Signed
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        Date:
                                        <div style="text-align: right">
                                            <input id="physician_signed_date" name="physician_signed_date" type="text" class="field text addr tbox calendar" value="<?php echo $physician_signed_date?>" style="width:100px;" maxlength="255" onChange="validateDate('physician_signed_date');" placeholder="YYYY-MM-DD" data-date-format="Y-m-d" />
                                        </div>
                                    </td>
                                    <td class="b_line label" align="left" valign="top" width="13"></td>
                                    <td valign="top" width="50%">
                                        <span class="num">32.</span>
                                        Service Facility Location Information
                                        <input type="text" style="visibility:hidden;width:1px;" class="spacer-dont-name" />
                                        <table width="100%" cellpadding="1" cellspacing="1" border="0">
                                            <tr>
                                                <td valign="top" width="10%">
                                                    <span class="small_cap">Name:</span>
                                                </td>
                                                <td valign="top" width="90%" colspan="2">
                                                    <input type="text" value="<?= $service_facility_info_name ?>" name="service_facility_info_name" class="inbox_line3" size="40" />
                                                </td>
                                            </tr>
                                            <tr>
                                                <td valign="top" width="10%">
                                                    <span class="small_cap">Address:</span>
                                                </td>
                                                <td valign="top" width="90%" colspan="2">
                                                    <input type="text" value="<?= $service_facility_info_address ?>" name="service_facility_info_address" class="inbox_line3" size="40" />
                                                </td>
                                            </tr>
                                            <tr>
                                                <td valign="top">
                                                    <span class="small_cap">City/State/Zip</span>
                                                </td>
                                                <td valign="top" colspan="2">
                                                    <input type="text" name="service_facility_info[city]" class="inbox_line3 inbox-third" placeholder="City" value="<?= $service_facility_info['city'] ?>" />
                                                    <select name="service_facility_info[state]">
                                                        <option></option>
                                                        <?php foreach (stateList() as $stateCode=>$stateName) { ?>
                                                            <option value="<?= $stateCode ?>"
                                                                <?= ($service_facility_info['stateCode'] == $stateCode ? 'selected' : '') ?>>
                                                                <?= "$stateCode - $stateName" ?>
                                                            </option>
                                                        <?php } ?>
                                                    </select>
                                                    <input type="text" name="service_facility_info[zip]" class="inbox_line3 inbox-third" placeholder="Zip" value="<?= $service_facility_info['zip'] ?>" />
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="2" width="40%">
                                                    <span class="num_a">
                                                        a.
                                                    </span>
                                                    <input type="text" value="<?= $service_info_a ?>"
                                                        name="service_info_a" class="inbox_line3" size="15" />
                                                </td>
                                                <td>
                                                    <span class="num_a">
                                                        b.
                                                    </span>
                                                    <select name="service_info_dd" class="inbox_line3" style="width:50px;">
                                                        <option value=""></option>
                                                        <?php foreach ($qualifiers as $qualifier) { ?>
                                                            <option value="<?= $qualifier['qualifierid'] ?>"
                                                                <?= $service_info_dd == $qualifier['qualifierid'] ? 'selected' : '' ?>>
                                                                <?= st($qualifier['qualifier']) ?>
                                                            </option>
                                                        <?php } ?>
                                                    </select>
                                                    <input type="text" value="<?= htmlspecialchars($service_info_b_other) ?>" name="service_info_b_other" class="inbox_line3 inbox-half" size="15" />
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td valign="top" >
                            <table width="100%" cellpadding="1" cellspacing="1" border="0">
                                <tr>
                                    <td colspan="3" width="50%">
                                        <span class="num">33.</span>
                                        Billing Provider Info & Ph#
                                    </td>
                                    <td>
                                        <span class="style1">
                                            (<input type="text" value="<?php echo  $billing_provider_phone_code; ?>" name="billing_provider_phone_code" size="3" class="inbox_line3 inbox-third phonecodemask" />)
                                        </span>
                                        &nbsp;&nbsp;&nbsp;
                                        <input type="text" value="<?php echo  $billing_provider_phone; ?>" name="billing_provider_phone" class="inbox_line3 inbox-half phonemask" size="13"  />
                                    </td>
                                </tr>
                                <tr>
                                    <td valign="top" width="10%">
                                        <span class="small_cap">Name:</span>
                                    </td>
                                    <td valign="top" width="90%" colspan="3">
                                        <input type="text" value="<?php echo ($billing_provider_name && $billing_provider_name != '')?$billing_provider_name:$practice;?>" name="billing_provider_name" class="inbox_line3" size="40" />
                                    </td>
                                </tr>
                                <tr>
                                    <td valign="top" width="10%">
                                        <span class="small_cap">Address:</span>
                                    </td>
                                    <td valign="top" width="90%" colspan="3">
                                        <input type="text" value="<?php echo ($billing_provider_address && $billing_provider_address != '')?$billing_provider_address:$address;?>" name="billing_provider_address" class="inbox_line3" size="40" />
                                    </td>
                                </tr>
                                <tr>
                                    <td valign="top" width="10%">
                                        <span class="small_cap">City/State/Zip:</span>
                                    </td>
                                    <td valign="top" colspan="3">
                                        <input type="text" name="billing_provider_info[city]" class="inbox_line3 inbox-third" placeholder="City" value="<?= $billing_provider_info['city'] ?>" />
                                        <select name="billing_provider_info[state]">
                                            <option></option>
                                            <?php foreach (stateList() as $stateCode => $stateName) { ?>
                                                <option value="<?= $stateCode ?>"
                                                    <?= ($billing_provider_info['stateCode'] == $stateCode ? 'selected' : '') ?>>
                                                    <?= "$stateCode - $stateName" ?>
                                                </option>
                                            <?php } ?>
                                        </select>
                                        <input type="text" name="billing_provider_info[zip]" class="inbox_line3 inbox-third" placeholder="Zip" value="<?= $billing_provider_info['zip'] ?>" />
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                        <span class="num_a">
                                            a.
                                        </span>
                                        <input type="text" value="<?= ($billing_provider_a != '') ? $billing_provider_a : (($insurancetype == '1') ? $medicare_npi : $npi); ?>" name="billing_provider_a" class="inbox_line3" size="15" />
                                    </td>
                                    <td colspan="2">
                                        <span class="num_a">
                                            b.
                                        </span>
                                        <select name="billing_provider_dd" class="inbox_line3" style="width:50px;">
                                            <option value=""></option>
                                            <?php foreach ($qualifiers as $qualifier) { ?>
                                                <option value="<?= $qualifier['qualifierid'] ?>"
                                                    <?= $billing_provider_dd == $qualifier['qualifierid'] ? 'selected' : '' ?>>
                                                    <?= st($qualifier['qualifier']) ?>
                                                </option>
                                            <?php } ?>
                                        </select>
                                        <input type="text" value="<?= htmlspecialchars($billing_provider_b_other) ?>" name="billing_provider_b_other" class="inbox_line3 inbox-half" size="15" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <?php if (!$isHistoricView) { ?>
        <?php if ($status==DSS_CLAIM_PENDING || $status==DSS_CLAIM_REJECTED) { ?>
            <?php if ($_SERVER['PHP_SELF'] != "/manage/admin/insurance_claim.php") { ?>
            <div style="float:right;">
                <?php if (!$isSent && !in_array($status, [DSS_CLAIM_PENDING, DSS_CLAIM_SEC_PENDING, DSS_CLAIM_REJECTED, DSS_CLAIM_SEC_REJECTED])) { // Based on "else if" blocks from above ?>
                    <input type="submit" name="ex_pagebtn" value="Print Claim"
                        <?php if($status == DSS_CLAIM_REJECTED || $status == DSS_CLAIM_SEC_REJECTED){ ?>
                            onclick="return confirm('This claim has been rejected. By printing this claim the status will be changed to SENT, and the rejection notification will be removed. Click OK to proceed.');"
                        <?php } ?>
                    />
                    <input type="button" name="elec" onclick="return change_form();" value="Switch to E-File" />
                    <input type="submit" name="elec_save" id="elec_save" style="display:none;" />
                <?php } elseif ($_SESSION['user_type'] == DSS_USER_TYPE_SOFTWARE) { ?>
                    <?php
                    if(($isPending || $isDispute || $isRejected) && $p_m_dss_file == '2'){
                        $api_sql = "SELECT use_eligible_api FROM dental_users WHERE userid='".$db->escape($_SESSION['docid'])."'";
                        $api_r = $db->getRow($api_sql);
                        if($api_r['use_eligible_api'] == 1) {
                            if ($isPending) { ?>
                                <input type="button" name="elec" onclick="return change_form();" value="Switch to E-File" />
                                <input type="submit" name="elec_save" id="elec_save" style="display:none;" />
                            <?php }elseif($isRejected || $isDispute){ ?>
                                <input type="button" name="elec" onclick="return change_form();" value="Switch to E-File" />
                                <?php
                            }
                        }
                    }
                } elseif(($status == DSS_CLAIM_SEC_PENDING || $status == DSS_CLAIM_SEC_REJECTED) && $s_m_dss_file == '2'){ ?>
                    Mark Sent <input type="checkbox" name="status_chk" disabled="disabled" value="<?php echo DSS_CLAIM_SEC_SENT?>" checked="checked" />
                    <input type="hidden" name="status" value="<?php echo DSS_CLAIM_SEC_SENT?>" />
                    <?php if (!$isSent) {  ?>
                        <input type="submit" name="ex_pagebtn" value="Print Claim" />
                    <?php } ?>
                <?php } ?>
            </div>
            <?php } ?>
        <?php } ?>
    <?php } ?>
</form>

<div id="popupContact" style="width:750px;">
    <a id="popupContactClose"><button>X</button></a>
    <iframe id="aj_pop" width="100%" height="100%" frameborder="0" marginheight="0" marginwidth="0"></iframe>
</div>
<div id="backgroundPopup"></div>
<script>
    <?php if ($isHistoricView || ($belongsToBackOffice !== $isBackOffice)) { ?>
        jQuery(function($){
            $('form#claim-form').find('input, select, button').prop('disabled', true);
        });
    <?php } ?>
    $(".date_field").keydown(function(e){
        var key = e.charCode || e.keyCode || 0;
        // allow backspace, tab, delete, arrows, numbers and keypad numbers ONLY
        return (
            key === 8 ||
            key === 9 ||
            key === 46 ||
            key === 189 ||
            key === 191 ||
            (key >= 37 && key <= 40) ||
            (key >= 48 && key <= 57) ||
            (key >= 96 && key <= 105)
        );
    });
    $(".number_field").keydown(function (e) {
        var key = e.charCode || e.keyCode || 0;
        // allow backspace, tab, delete, numbers and keypad numbers ONLY
        return (
            key === 8 ||
            key === 9 ||
            key === 46 ||
            key === 110 ||
            key === 190 ||
            (key >= 48 && key <= 57) ||
            (key >= 96 && key <= 105)
        );
    });

    function file_reject_claim() {
        if($('#p_m_ins_payer_id').val()==""){
            alert('Insurance payer must be selected to electronically file claim.');
            return false;
        }
        c = confirm('You are about to resubmit a rejected claim. Please make sure you have corrected all errors, then click OK to resend the claim.');
        return c;
    }

    function file_claim() {
        if($('#p_m_ins_payer_id').val()==""){
            alert('Insurance payer must be selected to electronically file claim.');
            return false;
        }
        c = confirm('You are about to electronically submit this claim, are you sure?');
        return c;
    }

    function change_form() {
        if(form_changed){
            if(confirm('Your changes to this claim will be lost if you change to electronic submission. Click \'Ok\' to proceed or \'Cancel\' to return to paper form.')){
                window.location = "<?php echo  $electronic_form; ?>";
            }
        }else{
            window.location = "<?php echo  $electronic_form; ?>";
        }
        return false;
    }

    form_changed = false;
    $('input, select').bind('change', function(){
        form_changed=true;
    });

    $(document).ready(function(){
        $('#claim-form-table')
            .removeAttr('width')
            .addClass('eligibleapi claim')
            .find('td')
            .addClass('label');

        $('\
            [name="field_17a"],\
            [name="field_17a_dd"]\
        ')
            .attr('readonly', true)
            .addClass('grayout')
            .closest('td')
            .addClass('grayout');

        // Save time and let the "Switch to E-File" button be created, then we just move it
        $('[name=elec][value="Switch to E-File"]:first')
            .css({ float: 'right', 'margin-right': '5px' })
            .appendTo('#top-banner');

        $('[name=preserve_status]')
            .removeAttr('onclick')
            .click(function(){
            return confirm("This action creates a new PDF claim with updated data.\n\nThe original claim status will NOT change, but the data\nyou enter will overwrite previous claim data.\n\nProceed?");
        });

        function debounceCall (call, options) {
            var timeoutId = 0;

            options = $.extend({
                timeout: 600,
                context: null,
                onTick: null
            }, options);

            return function () {
                var argumentArray = Array.prototype.slice.call(arguments, 0);

                if (timeoutId) {
                    clearTimeout(timeoutId);
                    timeoutId = 0;
                }

                if (options.onTick) {
                    options.onTick.apply(options.context, argumentArray);
                }

                timeoutId = setTimeout(function(){
                    call.apply(options.context, argumentArray);
                }, options.timeout);
            };
        }

        /**
         * Handle Secondary Insurance logic, field 11.d and fields in box 9.
         */
        (function(){
            $('body').append('<style>.warning{background-color:#fcc;}</style>');

            var $secondaryInsuranceIndicator = $('[name=another_plan], [name=other_payer]'),
                $parent = $secondaryInsuranceIndicator.closest('td.label, table.eligibleapi.claim'),
                $requiredFields = $('\
                    [name=other_insured_lastname], [name="other_payers[0][subscriber][last_name]"],\
                    [name=other_insured_firstname], [name="other_payers[0][subscriber][first_name]"],\
                    [name=other_insured_middle], [name="other_payers[0][subscriber][middle_name]"],\
                    [name=other_insured_policy_group_feca], [name="other_payers[0][subscriber][group_id]"],\
                    [name=patient_relation_other_insured], [name="other_payers[0][subscriber][relationship]"],\
                    [name=other_insured_insurance_plan], [name="other_payers[0][name]"],\
                    [name=responsibility_sequence], [name="other_payers[0][responsibility_sequence]"]\
                '),
                $optionalFields = $('[name=other_insured_insurance_type], [name="other_payers[0][subscriber][insurance_type_code]"]'),
                $associatedFields = $requiredFields.add($optionalFields),
                $allFields = $secondaryInsuranceIndicator.add($associatedFields);

            function onIndicatorChange () {
                var $indicator = $secondaryInsuranceIndicator.filter(':checked'),
                    indicatorSelected = !!$indicator.val().match(/yes|true/),
                    fieldTitle = '', parentTitle = '', $fieldList;

                $associatedFields.removeClass('warning');
                $parent.removeClass('warning');

                if (!$indicator.length) {
                    return;
                }

                if (indicatorSelected) {
                    $fieldList = $requiredFields;
                    fieldTitle = 'Secondary Insurance is marked as "Yes", this field is required.';
                    parentTitle = 'Required fields in Box 9 related to secondary insurance are incomplete.';
                } else {
                    $fieldList = $associatedFields;
                    fieldTitle = 'Secondary Insurance is marked as "No", this field should be empty.';
                    parentTitle = 'No secondary insurance specified. Fields in Box 9 should be empty.';
                }

                $fieldList.each(function () {
                    var $this = $(this),
                        empty = !$this.val().trim().length;

                    if (indicatorSelected ? empty : !empty) {
                        $this.addClass('warning').attr('title', fieldTitle);
                    } else {
                        $this.removeAttr('title');
                    }
                });

                if ($fieldList.filter('.warning').length) {
                    $parent.addClass('warning').attr('title', parentTitle);
                } else {
                    $parent.removeAttr('title');
                }
            }

            $allFields.change(debounceCall(onIndicatorChange));
            $secondaryInsuranceIndicator.change();
        }());
    });
</script>
</body>
</html>
<?php
/**
 * Auxiliary function to encapsulate the save logic
 *
 * The $formerStatus status can be determined from the $claimId, but we take the "lazy load" approach and reuse
 * the value already determined before calling this function.
 *
 * @param int   $claimId
 * @param int   $patientId
 * @param array $claimData
 * @param int   $formerStatus
 * @param bool  $filedByBackOffice
 * @return int
 */
function savePaperClaimForm ($claimId, $patientId, $claimData, $formerStatus, $filedByBackOffice = false) {
    $db = new Db();

    /**
     * Session 'userid' is not reliable if we are not navigating a BO page
     */
    $userId = $filedByBackOffice ? 0 : intval($_SESSION['userid']);

    $claimId = intval($claimId);
    $patientId = intval($patientId);
    $isNewClaim = !$claimId;

    $isFormerPrimary = !$db->getColumn("SELECT primary_claim_id FROM dental_insurance WHERE insuranceid = '$claimId'", 'primary_claim_id', 0);
    $isFormerPending = ClaimFormData::isStatus('pending', $formerStatus);
    $isFormerRejected = ClaimFormData::isStatus('rejected', $formerStatus);
    $needsBackOfficeMarkerUpdate = $isFormerPending || $isFormerRejected;

    $filedByBackOfficeMarker = $filedByBackOffice && $needsBackOfficeMarkerUpdate ? 3 : 0;

    /**
     * Status changes:
     *
     * - IF marked to preserve the status THEN $formerStatus
     * - IF marked for rejection THEN rejected
     * - IF new claim THEN pending
     * - IF pending THEN sent
     * - IF rejected THEN sent
     * - ELSE preserve the current status
     */
    if (!empty($claimData['preserve_status'])) {
        $status = $formerStatus;
    } elseif (isset($claimData['reject_but'])) {
        $status = $isFormerPrimary ? DSS_CLAIM_REJECTED : DSS_CLAIM_SEC_REJECTED;
    } elseif ($isNewClaim) {
        $status = $isFormerPrimary ? DSS_CLAIM_PENDING : DSS_CLAIM_SEC_PENDING;
    } elseif ($isFormerPending || $isFormerRejected) {
        $status = $isFormerPrimary ? DSS_CLAIM_SENT : DSS_CLAIM_SEC_SENT;
    } else {
        $status = $formerStatus;
    }

    $patientData = $db->getRow("SELECT has_s_m_ins, docid FROM dental_patients WHERE patientid = '$patientId'");
    $patientData = $patientData ?: [];

    $docId = intval($patientData['docid']);

    // Put POST values into variables
    $pica1 = $claimData['pica1'];
    $pica2 = $claimData['pica2'];
    $pica3 = $claimData['pica3'];
    $insurance_type = $claimData['insurance_type'];
    $other_insurance_type = $claimData['other_insurance_type'];
    $patient_lastname = $claimData['patient_lastname'];
    $patient_firstname = $claimData['patient_firstname'];
    $patient_middle = $claimData['patient_middle'];
    //we need to convert the DOB from mm-dd-yyyy to YYYY-MM-dd
    $patient_dob = dateFormat($claimData['patient_dob'], false);
    $patient_sex = $claimData['patient_sex'];
    $patient_address = $claimData['patient_address'];
    $patient_city = $claimData['patient_city'];
    $patient_state = $claimData['patient_state'];
    $patient_status = !empty($claimData['patient_status']) ? $claimData['patient_status'] : '';
    $work_status = !empty($claimData['work_status']) ? $claimData['work_status'] : '';
    $current_qual = !empty($claimData['current_qual']) ? $claimData['current_qual'] : '';
    $same_illness_qual = !empty($claimData['same_illness_qual']) ? $claimData['same_illness_qual'] : '';
    $patient_zip = $claimData['patient_zip'];

    list($patient_phone_code, $patient_phone) = parsePhoneNumber($claimData['patient_phone_code'], $claimData['patient_phone']);

    $insured_id_number = $claimData['insured_id_number'];
    $insured_firstname = $claimData['insured_firstname'];
    $insured_lastname = $claimData['insured_lastname'];
    $insured_middle = $claimData['insured_middle'];
    $patient_relation_insured = $claimData['patient_relation_insured'];
    $patient_relation_other_insured = $claimData['patient_relation_other_insured'];
    $insured_address = $claimData['insured_address'];
    $insured_state = $claimData['insured_state'];
    $insured_city = $claimData['insured_city'];
    $insured_zip = $claimData['insured_zip'];

    list($insured_phone_code, $insured_phone) = parsePhoneNumber($claimData['insured_phone_code'], $claimData['insured_phone']);

    $other_insured_id_number = $claimData['other_insured_id_number'];
    $other_insured_firstname = $claimData['other_insured_firstname'];
    $other_insured_lastname = $claimData['other_insured_lastname'];
    $other_insured_middle = $claimData['other_insured_middle'];
    $employment = !empty($claimData['employment']) ? $claimData['employment'] : '';
    $auto_accident = !empty($claimData['auto_accident']) ? $claimData['auto_accident'] : '';
    $auto_accident_place = $claimData['auto_accident_place'];
    $other_accident = !empty($claimData['other_accident']) ? $claimData['other_accident'] : '';
    $insured_policy_group_feca = $claimData['insured_policy_group_feca'];
    $other_insured_policy_group_feca = $claimData['other_insured_policy_group_feca'];
    $responsibility_sequence = !empty($claimData['responsibility_sequence']) ? $claimData['responsibility_sequence'] : '';
    //we need to convert the DOB from mm-dd-yyyy to YYYY-MM-dd
    $insured_dob = dateFormat($claimData['insured_dob'], false);
    $insured_sex = $claimData['insured_sex'];
    $other_insured_dob = dateFormat($claimData['other_insured_dob'], false);
    $other_insured_sex = !empty($claimData['other_insured_sex']) ? $claimData['other_insured_sex'] : '';
    $insured_employer_school_name = !empty($claimData['insured_employer_school_name']) ? $claimData['insured_employer_school_name'] : '';
    $other_insured_employer_school_name = !empty($claimData['other_insured_employer_school_name']) ? $claimData['other_insured_employer_school_name'] : '';
    $insured_insurance_plan = $claimData['insured_insurance_plan'];
    $other_insured_insurance_plan = $claimData['other_insured_insurance_plan'];
    $reserved_local_use = !empty($claimData['reserved_local_use']) ? $claimData['reserved_local_use'] : '';
    $another_plan = $claimData['another_plan'];
    $patient_signature = $claimData['patient_signature'];
    $patient_signed_date = $claimData['patient_signed_date'];
    $insured_signature = $claimData['insured_signature'];
    $date_current = $claimData['date_current'];
    $date_same_illness = $claimData['date_same_illness'];
    $unable_date_from = $claimData['unable_date_from'];
    $unable_date_to = $claimData['unable_date_to'];
    $name_referring_provider_qualifier = $claimData['name_referring_provider_qualifier'];
    $referring_provider = $claimData['referring_provider'];
    $field_17a_dd = $claimData['field_17a_dd'];
    $field_17a = $claimData['field_17a'];
    $field_17b = $claimData['field_17b'];
    $hospitalization_date_from = $claimData['hospitalization_date_from'];
    $hospitalization_date_to = $claimData['hospitalization_date_to'];
    $reserved_local_use1 = $claimData['reserved_local_use1'];
    $outside_lab = !empty($claimData['outside_lab']) ? $claimData['outside_lab'] : '';
    $s_charges = $claimData['s_charges'];
    $diagnosis_1 = !empty($claimData['diagnosis_1']) ? $claimData['diagnosis_1'] : '';
    $diagnosis_2 = !empty($claimData['diagnosis_2']) ? $claimData['diagnosis_2'] : '';
    $diagnosis_3 = !empty($claimData['diagnosis_3']) ? $claimData['diagnosis_3'] : '';
    $diagnosis_4 = !empty($claimData['diagnosis_4']) ? $claimData['diagnosis_4'] : '';

    $icd_ind = $claimData['icd_ind'];

    $diagnosis_a = $claimData['diagnosis_a'];
    $diagnosis_b = $claimData['diagnosis_b'];
    $diagnosis_c = $claimData['diagnosis_c'];
    $diagnosis_d = $claimData['diagnosis_d'];
    $diagnosis_e = $claimData['diagnosis_e'];
    $diagnosis_f = $claimData['diagnosis_f'];
    $diagnosis_g = $claimData['diagnosis_g'];
    $diagnosis_h = $claimData['diagnosis_h'];
    $diagnosis_i = $claimData['diagnosis_i'];
    $diagnosis_j = $claimData['diagnosis_j'];
    $diagnosis_k = $claimData['diagnosis_k'];
    $diagnosis_l = $claimData['diagnosis_l'];
    $medicaid_resubmission_code = (!empty($claimData['medicaid_resubmission_code']) ? $claimData['medicaid_resubmission_code'] : '');
    $resubmission_code_fill = $claimData['resubmission_code_fill'];
    $original_ref_no = $claimData['original_ref_no'];
    $prior_authorization_number = $claimData['prior_authorization_number'];

    $placesOfService = $db->getResults('SELECT place_service, description
        FROM dental_place_service
        WHERE status = 1');

    $transactionCodes = $db->getResults("SELECT
            code.transaction_code,
            code.description,
            CONCAT(code.transaction_code, ' - ', code.description) AS long_description
        FROM dental_transaction_code code
        JOIN dental_insurance claim ON claim.docid = code.docid
        WHERE claim.insuranceid = '$claimId'");

    $placesOfService = $placesOfService ? array_pluck($placesOfService, 'place_service') : [];

    $codes = array_pluck($transactionCodes, 'transaction_code');
    $descriptions = array_pluck($transactionCodes, 'description');
    $longDescriptions = array_pluck($transactionCodes, 'long_description');

    $fieldMap = [
        'rendering_provider_id%n%' => 'service_lines.%n%.ledger_id',
        'service_date%n%_from' => 'service_lines.%n%.service_date_from',
        'service_date%n%_to' => 'service_lines.%n%.service_date_to',
        'place_of_service%n%' => 'service_lines.%n%.place_of_service',
        'emg%n%' => 'service_lines.%n%.emergency',
        'cpt_hcpcs%n%' => 'service_lines.%n%.procedure_code',
        'modifier%n%_1' => 'service_lines.%n%.procedure_modifiers.0',
        'modifier%n%_2' => 'service_lines.%n%.procedure_modifiers.1',
        'modifier%n%_3' => 'service_lines.%n%.procedure_modifiers.2',
        'modifier%n%_4' => 'service_lines.%n%.procedure_modifiers.3',
        'diagnosis_pointer%n%' => 'service_lines.%n%.diagnosis_code_pointers',
        's_charges%n%_1' => 'service_lines.%n%.charge_amount',
        's_charges%n%_2' => '',
        'days_or_units%n%' => 'service_lines.%n%.units',
        'epsdt_family_plan%n%' => 'service_lines.%n%.epsdt',
        'id_qua%n%' => 'service_lines.%n%.qualifier',
        'rendering_provider_npi_%n%' => 'service_lines.%n%.rendering_provider.npi',
    ];

    for ($line = 0; $line < 6; $line++) {
        $keys = array_keys($fieldMap);
        $fields = array_values($fieldMap);

        array_walk($keys, function (&$each) use ($line) {
            $each = str_replace('%n%', $line + 1, $each);
        });

        array_walk($fields, function (&$each) use ($line) {
            $each = str_replace('%n%', $line, $each);
        });

        $currentMap = array_combine($keys, $fields);

        foreach ($currentMap as $localVariable => $remoteVariable) {
            ${$localVariable} = array_get($claimData, $remoteVariable);

            if (substr($localVariable, 0, 3) === 'emg') {
                ${$localVariable} = isOptionSelected(${$localVariable});
            } elseif (substr($localVariable, 0, 9) === 's_charges') {
                ${$localVariable} = preg_replace('/[^\d\.]+/', '', ${$localVariable});
            } elseif (substr($localVariable, 0, 5) === 'place') {
                ${$localVariable} = in_array(${$localVariable}, $placesOfService) ? ${$localVariable} : null;
            } elseif (substr($localVariable, 0, 17) === 'diagnosis_pointer') {
                if (is_array(${$localVariable})) {
                    ${$localVariable} = join(',', ${$localVariable});
                }
            } elseif (substr($localVariable, 0, 3) === 'cpt') {
                /**
                 * Ensure the procedure code exists, and is associated to the docid
                 */
                $codeIndex = array_filter([
                    array_search(${$localVariable}, $codes),
                    array_search(${$localVariable}, $descriptions),
                    array_search(${$localVariable}, $longDescriptions),
                ], function ($each) { return $each !== false; });

                $codeIndex = count($codeIndex) ? array_shift($codeIndex) : false;
                ${$localVariable} = $codeIndex !== false ? $codes[$codeIndex] : null;
            }
        }
    }

    $federal_tax_id_number = !empty($claimData['federal_tax_id_number']) ? $claimData['federal_tax_id_number'] : '';
    $ssn = !empty($claimData['ssnein']) && $claimData['ssnein'] == 'ssn' ? 1 : '';
    $ein = !empty($claimData['ssnein']) && $claimData['ssnein'] == 'ein' ? 1 : '';
    $patient_account_no = $claimData['patient_account_no'];
    $accept_assignment = $claimData['accept_assignment'];
    $total_charge = $claimData['total_charge'];
    $amount_paid = $claimData['amount_paid'];
    $balance_due = !empty($claimData['balance_due']) ? $claimData['balance_due'] : '';

    $physician_signed_date = dateFormat($claimData['physician_signed_date'], false);
    $service_facility_info_name = $claimData['service_facility_info_name'];
    $service_facility_info_address = $claimData['service_facility_info_address'];

    $service_facility_info_city = $claimData['service_facility_info']['city'] . ' ' .
        $claimData['service_facility_info']['state'] . ' ' . $claimData['service_facility_info']['zip'];

    $service_info_a = $claimData['service_info_a'];
    $service_info_dd = $claimData['service_info_dd'];
    $service_info_b_other = $claimData['service_info_b_other'];

    list($billing_provider_phone_code, $billing_provider_phone) = parsePhoneNumber($claimData['billing_provider_phone_code'], $claimData['billing_provider_phone']);

    $billing_provider_name = $claimData['billing_provider_name'];
    $billing_provider_address = $claimData['billing_provider_address'];
    $billing_provider_city = $claimData['billing_provider_info']['city'] . ' ' . $claimData['billing_provider_info']['state'] . ' ' . $claimData['billing_provider_info']['zip'];
    $billing_provider_a = $claimData['billing_provider_a'];
    $billing_provider_dd = $claimData['billing_provider_dd'];
    $billing_provider_b_other = $claimData['billing_provider_b_other'];
    $reject_reason = !empty($claimData['reject_reason']) ? $claimData['reject_reason'] : '';
    $nucc_8a = $claimData['nucc_8a'];
    $nucc_8b = $claimData['nucc_8b'];
    $nucc_9a = !empty($claimData['nucc_9a']) ? $claimData['nucc_9a'] : '';
    $nucc_9b = $claimData['nucc_9b'];
    $claim_codes = $claimData['claim_codes'];
    $other_claim_id = $claimData['other_claim_id'];
    $nucc_9c = $claimData['nucc_9c'];
    $nucc_30 = $claimData['nucc_30'];

    $patient_status_arr = '~'.$patient_status.'~'.$work_status.'~';

    $total_charge = number_format(preg_replace('/[^\d\.]+/', '', $total_charge), 2, '.', '');
    $amount_paid = number_format(preg_replace('/[^\d\.]+/', '', $amount_paid), 2, '.', '');

    // Insert new claim into dental_insurance table
    if ($isNewClaim) {
        $ins_sql = "INSERT INTO dental_insurance SET
            patientid = '".$db->escape($_GET['pid'])."',
            pica1 = '".$db->escape($pica1)."',
            pica2 = '".$db->escape($pica2)."',
            pica3 = '".$db->escape($pica3)."',
            insurance_type = '".$db->escape($insurance_type)."',
            other_insurance_type = '".$db->escape($other_insurance_type)."',
            insured_id_number = '".$db->escape($insured_id_number)."',
            patient_lastname = '".$db->escape($patient_lastname)."',
            patient_firstname = '".$db->escape($patient_firstname)."',
            patient_middle = '".$db->escape($patient_middle)."',
            patient_dob = '".$db->escape($patient_dob)."',
            patient_sex = '".$db->escape($patient_sex)."',
            insured_firstname = '".$db->escape($insured_firstname)."',
            insured_lastname = '".$db->escape($insured_lastname)."',
            insured_middle = '".$db->escape($insured_middle)."',
            patient_address = '".$db->escape($patient_address)."',
            patient_relation_insured = '".$db->escape($patient_relation_insured)."',
            patient_relation_other_insured = '".$db->escape($patient_relation_other_insured)."',
            patient_city = '".$db->escape($patient_city)."',
            patient_state = '".$db->escape($patient_state)."',
            patient_status = '".$db->escape($patient_status_arr)."',
            patient_zip = '".$db->escape($patient_zip)."',
            patient_phone_code = '".$db->escape($patient_phone_code)."',
            patient_phone = '".$db->escape($patient_phone)."',
            insured_address = '".$db->escape($insured_address)."',
            insured_city = '".$db->escape($insured_city)."',
            insured_state = '".$db->escape($insured_state)."',
            insured_zip = '".$db->escape($insured_zip)."',
            insured_phone_code = '".$db->escape($insured_phone_code)."',
            insured_phone = '".$db->escape($insured_phone)."',
            other_insured_id_number = '".$db->escape($other_insured_id_number)."',
            other_insured_firstname = '".$db->escape($other_insured_firstname)."',
            other_insured_lastname = '".$db->escape($other_insured_lastname)."',
            other_insured_middle = '".$db->escape($other_insured_middle)."',
            employment = '".$db->escape($employment)."',
            auto_accident = '".$db->escape($auto_accident)."',
            auto_accident_place = '".$db->escape($auto_accident_place)."',
            other_accident = '".$db->escape($other_accident)."',
            insured_policy_group_feca = '".$db->escape($insured_policy_group_feca)."',
            other_insured_policy_group_feca = '".$db->escape($other_insured_policy_group_feca)."',
            responsibility_sequence = '".$db->escape($responsibility_sequence)."',
            insured_dob = '".$db->escape($insured_dob)."',
            insured_sex = '".$db->escape($insured_sex)."',
            other_insured_dob = '".$db->escape($other_insured_dob)."',
            other_insured_sex = '".$db->escape($other_insured_sex)."',
            insured_employer_school_name = '".$db->escape($insured_employer_school_name)."',
            other_insured_employer_school_name = '".$db->escape($other_insured_employer_school_name)."',
            insured_insurance_plan = '".$db->escape($insured_insurance_plan)."',
            other_insured_insurance_plan = '".$db->escape($other_insured_insurance_plan)."',
            reserved_local_use = '".$db->escape($reserved_local_use)."',
            another_plan = '".$db->escape($another_plan)."',
            patient_signature = '".$patient_signature."',
            patient_signed_date = '".$db->escape($patient_signed_date)."',
            insured_signature = '".$db->escape($insured_signature)."',
            date_current = '".$db->escape($date_current)."',
            current_qual = '".$db->escape($current_qual)."',
            same_illness_qual = '".$db->escape($same_illness_qual)."',
            date_same_illness = '".$db->escape($date_same_illness)."',
            unable_date_from = '".$db->escape($unable_date_from)."',
            unable_date_to = '".$db->escape($unable_date_to)."',
            name_referring_provider_qualifier = '".$db->escape($name_referring_provider_qualifier)."',
            referring_provider = '".$db->escape($referring_provider)."',
            field_17a_dd = '".$db->escape($field_17a_dd)."',
            field_17a = '".$db->escape($field_17a)."',
            field_17b = '".$db->escape($field_17b)."',
            hospitalization_date_from = '".$db->escape($hospitalization_date_from)."',
            hospitalization_date_to = '".$db->escape($hospitalization_date_to)."',
            reserved_local_use1 = '".$db->escape($reserved_local_use1)."',
            outside_lab = '".$db->escape($outside_lab)."',
            s_charges = '".$db->escape($s_charges)."',
            diagnosis_1 = '".$db->escape($diagnosis_1)."',
            diagnosis_2 = '".$db->escape($diagnosis_2)."',
            diagnosis_3 = '".$db->escape($diagnosis_3)."',
            diagnosis_4 = '".$db->escape($diagnosis_4)."',
            icd_ind = '".$db->escape($icd_ind)."',
            diagnosis_a = '".$db->escape($diagnosis_a)."',
            diagnosis_b = '".$db->escape($diagnosis_b)."',
            diagnosis_c = '".$db->escape($diagnosis_c)."',
            diagnosis_d = '".$db->escape($diagnosis_d)."',
            diagnosis_e = '".$db->escape($diagnosis_e)."',
            diagnosis_f = '".$db->escape($diagnosis_f)."',
            diagnosis_g = '".$db->escape($diagnosis_g)."',
            diagnosis_h = '".$db->escape($diagnosis_h)."',
            diagnosis_i = '".$db->escape($diagnosis_i)."',
            diagnosis_j = '".$db->escape($diagnosis_j)."',
            diagnosis_k = '".$db->escape($diagnosis_k)."',
            diagnosis_l = '".$db->escape($diagnosis_l)."',
            medicaid_resubmission_code = '".$db->escape($medicaid_resubmission_code)."',
            resubmission_code_fill = '".$db->escape($resubmission_code_fill)."',
            original_ref_no = '".$db->escape($original_ref_no)."',
            prior_authorization_number = '".$db->escape($prior_authorization_number)."',
            ";
        $ins_sql .= "
            federal_tax_id_number = '".$db->escape($federal_tax_id_number)."',
            ssn = '".$db->escape($ssn)."',
            ein = '".$db->escape($ein)."',
            patient_account_no = '".$db->escape($patient_account_no)."',
            accept_assignment = '".$db->escape($accept_assignment)."',
            total_charge = '".$db->escape($total_charge)."',
            amount_paid = '".$db->escape($amount_paid)."',
            balance_due = '".$db->escape($balance_due)."',
            nucc_8a = '".$db->escape($nucc_8a)."',
            nucc_8b = '".$db->escape($nucc_8b)."',
            nucc_9a = '".$db->escape($nucc_9a)."',
            nucc_9b = '".$db->escape($nucc_9b)."',
            claim_codes = '".$db->escape($claim_codes)."',
            other_claim_id = '".$db->escape($other_claim_id)."',
            nucc_9c = '".$db->escape($nucc_9c)."',
            nucc_30 = '".$db->escape($nucc_30)."',
            physician_signed_date = '".$db->escape($physician_signed_date)."',
            service_facility_info_name = '".$db->escape($service_facility_info_name)."',
            service_facility_info_address = '".$db->escape($service_facility_info_address)."',
            service_facility_info_city = '".$db->escape($service_facility_info_city)."',
            service_info_a = '".$db->escape($service_info_a)."',
            service_info_dd = '".$db->escape($service_info_dd)."',
            service_info_b_other = '".$db->escape($service_info_b_other)."',
            billing_provider_phone_code = '".$db->escape($billing_provider_phone_code)."',
            billing_provider_phone = '".$db->escape($billing_provider_phone)."',
            billing_provider_name = '".$db->escape($billing_provider_name)."',
            billing_provider_address = '".$db->escape($billing_provider_address)."',
            billing_provider_city = '".$db->escape($billing_provider_city)."',
            billing_provider_a = '".$db->escape($billing_provider_a)."',
            billing_provider_dd = '".$db->escape($billing_provider_dd)."',
            billing_provider_b_other = '".$db->escape($billing_provider_b_other)."',
            status = '$status',
            " . ($needsBackOfficeMarkerUpdate ? "p_m_dss_file = '$filedByBackOfficeMarker'," : '' ) . "
            userid = '".$db->escape($_SESSION['userid'])."',
            docid = '$docId',
            adddate = NOW(),
            ip_address = '".$db->escape($_SERVER['REMOTE_ADDR'])."'";

        // get the id of the inserted claim
        $claimId = $db->getInsertId($ins_sql);

        // update the ledger trxns passed in with the form
        updateLedgerTransactions ($claimId, DSS_TRXN_PROCESSING, $claimData['service_lines']);
        claim_status_history_update($claimId, $status, $formerStatus, $userId, $_SESSION['adminuserid']);
        claim_history_update($claimId, $userId, $_SESSION['adminuserid']);

        return $claimId;
    }

    $ed_sql = "UPDATE dental_insurance SET
        pica1 = '".$db->escape($pica1)."',
        pica2 = '".$db->escape($pica2)."',
        pica3 = '".$db->escape($pica3)."',
        patient_lastname = '".$db->escape($patient_lastname)."',
        patient_firstname = '".$db->escape($patient_firstname)."',
        patient_middle = '".$db->escape($patient_middle)."',
        patient_dob = '".$db->escape($patient_dob)."',
        patient_sex = '".$db->escape($patient_sex)."',
        patient_address = '".$db->escape($patient_address)."',
        patient_state = '".$db->escape($patient_state)."',
        patient_status = '".$db->escape($patient_status_arr)."',
        patient_city = '".$db->escape($patient_city)."',
        patient_zip = '".$db->escape($patient_zip)."',
        patient_phone_code = '".$db->escape($patient_phone_code)."',
        patient_phone = '".$db->escape($patient_phone)."',
        patient_relation_insured = '".$db->escape($patient_relation_insured)."',
        patient_relation_other_insured = '".$db->escape($patient_relation_other_insured)."',
        insurance_type = '".$db->escape($insurance_type)."',
        insured_id_number = '".$db->escape($insured_id_number)."',
        insured_firstname = '".$db->escape($insured_firstname)."',
        insured_lastname = '".$db->escape($insured_lastname)."',
        insured_middle = '".$db->escape($insured_middle)."',
        insured_address = '".$db->escape($insured_address)."',
        insured_city = '".$db->escape($insured_city)."',
        insured_state = '".$db->escape($insured_state)."',
        insured_zip = '".$db->escape($insured_zip)."',
        insured_phone_code = '".$db->escape($insured_phone_code)."',
        insured_phone = '".$db->escape($insured_phone)."',
        other_insured_id_number = '".$db->escape($other_insured_id_number)."',
        other_insured_firstname = '".$db->escape($other_insured_firstname)."',
        other_insured_lastname = '".$db->escape($other_insured_lastname)."',
        other_insured_middle = '".$db->escape($other_insured_middle)."',
        insured_policy_group_feca = '".$db->escape($insured_policy_group_feca)."',
        other_insured_policy_group_feca = '".$db->escape($other_insured_policy_group_feca)."',
        responsibility_sequence = '".$db->escape($responsibility_sequence)."',
        insured_dob = '".$db->escape($insured_dob)."',
        insured_sex = '".$db->escape($insured_sex)."',
        other_insured_dob = '".$db->escape($other_insured_dob)."',
        other_insured_sex = '".$db->escape($other_insured_sex)."',
        insured_employer_school_name = '".$db->escape($insured_employer_school_name)."',
        other_insured_employer_school_name = '".$db->escape($other_insured_employer_school_name)."',
        insured_insurance_plan = '".$db->escape($insured_insurance_plan)."',
        other_insured_insurance_plan = '".$db->escape($other_insured_insurance_plan)."',
        employment = '".$db->escape($employment)."',
        auto_accident = '".$db->escape($auto_accident)."',
        auto_accident_place = '".$db->escape($auto_accident_place)."',
        other_accident = '".$db->escape($other_accident)."',
        reserved_local_use = '".$db->escape($reserved_local_use)."',
        another_plan = '".$db->escape($another_plan)."',
        patient_signature = '".$db->escape($patient_signature)."',
        patient_signed_date = '".$db->escape($patient_signed_date)."',
        insured_signature = '".$db->escape($insured_signature)."',
        date_current = '".$db->escape($date_current)."',
        current_qual = '".$db->escape($current_qual)."',
        same_illness_qual = '".$db->escape($same_illness_qual)."',
        date_same_illness = '".$db->escape($date_same_illness)."',
        unable_date_from = '".$db->escape($unable_date_from)."',
        unable_date_to = '".$db->escape($unable_date_to)."',
        name_referring_provider_qualifier = '".$db->escape($name_referring_provider_qualifier)."',
        referring_provider = '".$db->escape($referring_provider)."',
        field_17a_dd = '".$db->escape($field_17a_dd)."',
        field_17a = '".$db->escape($field_17a)."',
        field_17b = '".$db->escape($field_17b)."',
        hospitalization_date_from = '".$db->escape($hospitalization_date_from)."',
        hospitalization_date_to = '".$db->escape($hospitalization_date_to)."',
        reserved_local_use1 = '".$db->escape($reserved_local_use1)."',
        outside_lab = '".$db->escape($outside_lab)."',
        s_charges = '".$db->escape($s_charges)."',
        diagnosis_1 = '".$db->escape($diagnosis_1)."',
        diagnosis_2 = '".$db->escape($diagnosis_2)."',
        diagnosis_3 = '".$db->escape($diagnosis_3)."',
        diagnosis_4 = '".$db->escape($diagnosis_4)."',
        icd_ind = '".$db->escape($icd_ind)."',
        diagnosis_a = '".$db->escape($diagnosis_a)."',
        diagnosis_b = '".$db->escape($diagnosis_b)."',
        diagnosis_c = '".$db->escape($diagnosis_c)."',
        diagnosis_d = '".$db->escape($diagnosis_d)."',
        diagnosis_e = '".$db->escape($diagnosis_e)."',
        diagnosis_f = '".$db->escape($diagnosis_f)."',
        diagnosis_g = '".$db->escape($diagnosis_g)."',
        diagnosis_h = '".$db->escape($diagnosis_h)."',
        diagnosis_i = '".$db->escape($diagnosis_i)."',
        diagnosis_j = '".$db->escape($diagnosis_j)."',
        diagnosis_k = '".$db->escape($diagnosis_k)."',
        diagnosis_l = '".$db->escape($diagnosis_l)."',
        medicaid_resubmission_code = '".$db->escape($medicaid_resubmission_code)."',
        resubmission_code_fill = '".$db->escape($resubmission_code_fill)."',
        original_ref_no = '".$db->escape($original_ref_no)."',
        prior_authorization_number = '".$db->escape($prior_authorization_number)."',
    ";
    $ed_sql .= "
        federal_tax_id_number = '".$db->escape($federal_tax_id_number)."',
        ssn = '".$db->escape($ssn)."',
        ein = '".$db->escape($ein)."',
        patient_account_no = '".$db->escape($patient_account_no)."',
        accept_assignment = '".$db->escape($accept_assignment)."',
        total_charge = '".$db->escape($total_charge)."',
        amount_paid = '".$db->escape($amount_paid)."',
        balance_due = '".$db->escape($balance_due)."',
        nucc_8a = '".$db->escape($nucc_8a)."',
        nucc_8b = '".$db->escape($nucc_8b)."',
        nucc_9a = '".$db->escape($nucc_9a)."',
        nucc_9b = '".$db->escape($nucc_9b)."',
        claim_codes = '".$db->escape($claim_codes)."',
        other_claim_id = '".$db->escape($other_claim_id)."',
        nucc_9c = '".$db->escape($nucc_9c)."',
        nucc_30 = '".$db->escape($nucc_30)."',
        physician_signed_date = '".$db->escape($physician_signed_date)."',
        service_facility_info_name = '".$db->escape($service_facility_info_name)."',
        service_facility_info_address = '".$db->escape($service_facility_info_address)."',
        service_facility_info_city = '".$db->escape($service_facility_info_city)."',
        service_info_a = '".$db->escape($service_info_a)."',
        service_info_dd = '".$db->escape($service_info_dd)."',
        service_info_b_other = '".$db->escape($service_info_b_other)."',
        billing_provider_phone_code = '".$db->escape($billing_provider_phone_code)."',
        billing_provider_phone = '".$db->escape($billing_provider_phone)."',
        billing_provider_name = '".$db->escape($billing_provider_name)."',
        billing_provider_address = '".$db->escape($billing_provider_address)."',
        billing_provider_city = '".$db->escape($billing_provider_city)."',
        billing_provider_a = '".$db->escape($billing_provider_a)."',
        billing_provider_dd = '".$db->escape($billing_provider_dd)."',
        billing_provider_b_other = '".$db->escape($billing_provider_b_other)."',

        status = '$status',
        " . ($needsBackOfficeMarkerUpdate ? "p_m_dss_file = '$filedByBackOfficeMarker'," : '' ) . "
        reject_reason = '".$db->escape($reject_reason)."'

        WHERE insuranceid = '$claimId'";

    $db->query($ed_sql);

    // update the ledger trxns passed in with the form
    $transactionStatus = ClaimFormData::isStatus('sent', $status) ? DSS_TRXN_SENT : DSS_TRXN_PROCESSING;

    updateLedgerTransactions($claimId, $transactionStatus, $claimData['service_lines']);
    claim_status_history_update($claimId, $status, $formerStatus, $userId, $_SESSION['adminuserid']);
    claim_history_update($claimId, $userId, $_SESSION['adminuserid']);

    if (isset($claimData['p_m_ins_payer_id'])) {
        $payerId = intval($claimData['p_m_ins_payer_id']);

        $db->query("UPDATE dental_patients
            SET p_m_eligible_id = '$payerId'
            WHERE patientid = '$patientId'");
    }

    if (isset($claimData['s_m_ins_payer_id'])) {
        $payerId = intval($claimData['s_m_ins_payer_id']);

        $db->query("UPDATE dental_patients
            SET s_m_eligible_id = '$payerId'
            WHERE patientid = '$patientId'");
    }
    return $claimId;
}

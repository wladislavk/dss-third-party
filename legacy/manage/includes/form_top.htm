<?php
namespace Ds3\Libraries\Legacy;

$fromLegacy = isset($baseTable);

$db = new Db();
$patientStatus = 0;
if (!empty($patientId)) {
    $patientStatus = (int)$db->getColumn("SELECT status FROM dental_patients WHERE patientid = $patientId", 'status');
}
$isPatientActive = $patientStatus !== DSS_PATIENT_STATUS_ACTIVE;

/**
 * Missing variable in most forms
 */
$cur_page = str_replace('.php', '', $_SERVER['SCRIPT_NAME']);
$slugName = preg_replace('/.+?\/(.+)$/', '$1', $cur_page);

$snapshotDate['parsed_date'] = $snapshotDate['updated_at'] ?: $snapshotDate['adddate'];
$snapshotDate['parsed_date'] = strtotime($snapshotDate['parsed_date']) ?
    date('m/d/Y H:i', strtotime($snapshotDate['parsed_date'])) : $snapshotDate['parsed_date'];

$initiatedTimestamp = strtotime($initiatedTimestamp) ?
    date('m/d/Y H:i' , strtotime($initiatedTimestamp)) : $initiatedTimestamp;
$lastModifiedTimestamp = strtotime($lastModifiedTimestamp) ?
    date('m/d/Y H:i' , strtotime($lastModifiedTimestamp)) : $lastModifiedTimestamp;

$sectionName = questionnairesExamsSectionName($patientStatus, $slugName);

?>
<script>
    var isHistoricView = <?= json_encode(!empty($isHistoricView)) ?>;
    var historyId = <?= json_encode(isset($historyId) ? $historyId : 0) ?>;
    var snapshotDate = <?= json_encode(isset($snapshotDate) ? $snapshotDate : '') ?>;
    var isCreateNew = <?= json_encode(isset($isCreateNew) ? $isCreateNew : '') ?>;
    var sectionName = <?= json_encode($sectionName['section']) ?>;
</script>
<style>
    .hidden { display: none; }
    .hidden.unhide { display: block; }

    form.ex_form.sidetabs, form.q_form.sidetabs {
        float: left;
        /* width: 94%; */
        width: 89%;
        border-right: 4px solid #ccc;
    }

    .history-selector {
        float: left;
        width: 10%;
        margin-left: -4px;
        background: #ccc;
    }

    .history-selector ul {
        margin: 0;
        padding: 0;
        text-align: left;
        list-style: none;
        list-style-position: unset;
        background: #fff;
    }

    .history-selector ul li {
        font-weight: bold;
        padding: 10px 3px 10px 10px;
        border: 1px solid #ccc;
        border-left-width: 4px;
        background: #eee;
        border-radius: 0 10px 0 0;
        margin-top: -1px;
    }

    .history-selector ul li:nth-child(1) {
        border-left-width: 1px;
        background: #fff;
    }

    .history-selector ul li:nth-child(2) {
        border-left-width: 1px;
        background: #fff;
    }

    .history-selector ul li:nth-child(3) {
        border-left-width: 2px;
        background: #fcfcfc;
    }

    .history-selector ul li:nth-child(4) {
        border-left-width: 3px;
        background: #f6f6f6;
    }

    .history-selector ul li:last-child {
        border-bottom-width: 1px;
    }

    .history-selector ul li.current {
        background: #fed68d;
        border-left-width: 0;
    }

    #history-timestamps {
        float: left;
        margin-left: 10px;
    }

    #history-timestamps table {
        display: inline-block;
        background-color: #fed68d;
        text-align: right;
        padding: 3px;
    }

    #history-timestamps table tbody {
        display: table;
        width: 100%;
    }

    #history-timestamps select {
        vertical-align: super;
    }

    tr.hidden.unhide {
        display: table-row;
    }

    #inactive-patient {
        display: none;
        margin: 1em;
        text-align: center;
    }
    <?php if (!$isPatientActive) { ?>
        .q_form.vue-module,
        .ex_form.vue-module,
        #archive-page-form,
        #history-selector,
        #history-timestamps { display:none; }
        #inactive-patient,
        .q_form.vue-module.from-legacy,
        .ex_form.vue-module.from-legacy { display: block; }
    <?php } ?>
</style>
<p>
    <a name="form"></a>
</p>
<script type="text/javascript" src="/manage/js/form_top.js?v=20180404"></script>
<div style="text-align: center">
    (Note: Sections left blank were not evaluated)
</div>
<?= questionnairesExamsMenu($patientStatus, $_SERVER['PHP_SELF'], 'menu-top') ?>
<div id="inactive-patient">
    Patient Inactive -- Please mark the patient as Active to enable this page.
</div>
<?php if ($fromLegacy) { ?>
    <div id="history-selector" class="history-selector">
        <ul>
            <li class="<?= !$historyId ? 'current' : '' ?>">
                <a href="?pid=<?= $patientId ?>"> Latest </a>
            </li>
            <?php foreach ((isset($historyList) ? $historyList : []) as $n => $each) {
                if (!$n) {
                    continue;
                }
                $each['selected_date'] = $each['updated_at'] ?: $each['history_created_at'];
                $unixTime = strtotime($each['selected_date']);
                $each['parsed_date'] = date('m/d/y', $unixTime);
                $each['parsed_time'] = date('H:i', $unixTime);

                if ($unixTime === false) {
                    $each['parsed_date'] = $each['selected_date'];
                    $each['parsed_time'] = '';

                    if (preg_match('/^(?P<date>.+?) (?P<time>\d+:\d+)$/', $each['selected_date'], $matches)) {
                        $each['parsed_date'] = $matches['date'];
                        $each['parsed_time'] = $matches['time'];
                    }
                }

                ?>
                <li class="<?= $each['id'] == $historyId ? 'current' : '' ?>">
                    <a href="?pid=<?= $patientId ?>&amp;history_id=<?= (int)$each['id'] ?>">
                        <?= e($each['parsed_date']) ?>
                        <small><?= e($each['parsed_time']) ?></small>
                    </a>
                </li>
            <?php } ?>
        </ul>
    </div>
<?php } ?>
<form method="post" class="hidden" id="archive-page-form">
    <input type="hidden" name="backup_table" value="1" />
</form>
<?php if ($fromLegacy) { ?>
    <div id="history-timestamps">
        <table>
            <colgroup>
                <col width="60%" />
                <col width="40%" />
            </colgroup>
            <tbody>
                <tr>
                    <td>Initiated:</td>
                    <td class="tz-timestamp initiated-timestamp"><?= $initiatedTimestamp ?></td>
                </tr>
                <tr>
                    <td>Last Modified:</td>
                    <td class="tz-timestamp"><?= $lastModifiedTimestamp ?></td>
                </tr>
            </tbody>
        </table>
        <?php if (!empty($canBackup)) { ?>
            <select>
                <option>
                    Create New and Archive &darr;
                </option>
                <option class="new-backup" data-section-name="<?= e($sectionName['name']) ?>">
                    Create New and Archive <?= e($sectionName['name']) ?>
                </option>
                <option class="backup-all-forms" data-section-name="<?= e(ucwords($sectionName['section'])) ?>">
                    Create New and Archive all pages of <?= e(ucwords($sectionName['section'])) ?>
                </option>
            </select>
        <?php } ?>
    </div>
<?php } ?>

<?php namespace Ds3\Libraries\Legacy; ?><?php

include_once('admin/includes/main_include.php');
include_once("includes/sescheck.php");
include_once('includes/constants.inc');
include_once('includes/authorization_functions.php');
include_once('includes/general_functions.php');
include_once('includes/notifications.php');
include_once('includes/patient_changes.php');

  if( $_SESSION['userid'] == '') {
?>

  	<script type="text/javascript">
  		alert("Members Area, Please Login");
  		window.location = "login.php";
  	</script>

<?php
  }

  if($_SESSION['loginid'] <> '') {
    $cur_page_full =  $_SERVER['PHP_SELF']."?".$_SERVER['QUERY_STRING'];
    $cur_ins_sql = "insert into dental_login_detail (loginid,userid,cur_page,adddate,ip_address) values('".$_SESSION['loginid']."','".$_SESSION['userid']."','".$cur_page_full."',now(),'".$_SERVER['REMOTE_ADDR']."')";
    $db->query($cur_ins_sql);
  }

  if (strpos($_SERVER['PHP_SELF'],'q_page') === false && strpos($_SERVER['PHP_SELF'],'ex_page') === false && strpos($_SERVER['PHP_SELF'],'q_sleep') === false && strpos($_SERVER['PHP_SELF'],'q_image') === false) {
  	$unload = 0 ;
  } else {
  	$unload = 1 ;
  }

  // Count letters
  $docid = $_SESSION['docid'];

  $dental_letters_query = "SELECT UNIX_TIMESTAMP(dental_letters.generated_date) as generated_date FROM dental_letters LEFT JOIN dental_patients ON dental_letters.patientid=dental_patients.patientid WHERE dental_letters.status = '0' AND dental_letters.deleted = '0' AND dental_letters.docid = '".$docid."' ORDER BY generated_date ASC;";

  $pending_letters = $db->getNumberRows($dental_letters_query);
  $generated_date = $db->getRow($dental_letters_query);

  $seconds_per_day = 86400;

  if ($generated_date == 0) {
  	$oldest_letter = 0;
  } else {
  	$oldest_letter = floor((time() - $generated_date['generated_date']) / $seconds_per_day);
  }

  $dental_letters_query = "SELECT letterid FROM dental_letters 
			LEFT JOIN dental_patients ON dental_letters.patientid=dental_patients.patientid 
			WHERE (dental_letters.status = '1' OR dental_letters.delivered=1) AND
        mailed_date IS NULL AND	dental_letters.deleted = '0' AND dental_letters.docid = '".$docid."'";

  $unmailed_letters = $db->getNumberRows($dental_letters_query);

  // Count Claims
  $claim_query = "SELECT * FROM dental_insurance WHERE docid = '".$docid."' AND (status='".DSS_CLAIM_PENDING."' OR status='".DSS_CLAIM_SEC_PENDING."')";

  $num_pending_claims = $db->getNumberRows($claim_query);

  $claim_query = "SELECT DISTINCT p.patientid FROM dental_ledger ledger
      JOIN dental_transaction_code trxn_code ON trxn_code.transaction_code = ledger.transaction_code
      JOIN dental_users user ON user.userid = ledger.docid
      JOIN dental_patients p ON p.patientid = ledger.patientid
      WHERE ledger.status = " . DSS_TRXN_PENDING ." AND ledger.docid = " . $_SESSION['docid'] . " AND trxn_code.docid = " . $_SESSION['docid'] . " AND trxn_code.type = " . DSS_TRXN_TYPE_MED;

  $num_pending_claims = $db->getNumberRows($claim_query);

  // Count Claims
  $claim_query = "SELECT * FROM dental_insurance WHERE docid = '".$docid."' AND (status='".DSS_CLAIM_PENDING."' OR status='".DSS_CLAIM_SEC_PENDING."')";

  $num_pending_claims = $db->getNumberRows($claim_query);

  $claim_query = "SELECT DISTINCT p.patientid FROM dental_ledger ledger
      JOIN dental_transaction_code trxn_code ON trxn_code.transaction_code = ledger.transaction_code
      JOIN dental_users user ON user.userid = ledger.docid
      JOIN dental_patients p ON p.patientid = ledger.patientid
      WHERE ledger.status = " . DSS_TRXN_PENDING ." AND ledger.docid = " . $_SESSION['docid'] . " AND trxn_code.docid = " . $_SESSION['docid'] . " AND p.p_m_dss_file = '2'
      AND trxn_code.type = " . DSS_TRXN_TYPE_MED;

  $num_pending_nodss_claims = $db->getNumberRows($claim_query);

  $claim_query = "SELECT * FROM dental_insurance WHERE docid = '".$docid."' AND mailed_date IS NULL AND status !=  ".DSS_CLAIM_PENDING." AND status != ".DSS_CLAIM_SEC_PENDING;

  $num_unmailed_claims = $db->getNumberRows($claim_query);

  // Count Preauths
  $preauth_query = "SELECT * FROM dental_insurance_preauth WHERE doc_id = '".$docid."' AND status=".DSS_PREAUTH_COMPLETE." AND (viewed IS NULL OR viewed != 1);";

  $num_preauth = $db->getNumberRows($preauth_query);

  $preauth_query = "SELECT * FROM dental_insurance_preauth WHERE doc_id = '".$docid."' AND status=".DSS_PREAUTH_PENDING.";";

  $num_pending_preauth = $db->getNumberRows($preauth_query);

  $pc_query = "SELECT * FROM dental_patient_contacts pc inner join dental_patients p on p.patientid=pc.patientid WHERE p.docid = '".$docid."'";

  $num_pc = $db->getNumberRows($pc_query);

  $pi_query = "SELECT * FROM dental_patient_insurance pi inner join dental_patients p on p.patientid=pi.patientid WHERE p.docid = '".$docid."'";

  $num_pi = $db->getNumberRows($pi_query);

  $c_query = "SELECT * FROM dental_patients p2 inner join dental_patients p on p.patientid=p2.parent_patientid WHERE p.docid = '".$docid."'";

  $num_c = $db->getNumberRows($c_query);

  $bounce_query = "SELECT * FROM dental_patients p WHERE p.email_bounce=1 AND p.docid = '".$docid."'";

  $num_bounce = $db->getNumberRows($bounce_query);

  $unsigned_query = "select * from (select n.*, u.name signed_name, p.adddate as parent_adddate from ( select * from dental_notes where status!=0 AND docid='".$_SESSION['docid']."' order by adddate desc ) as n LEFT JOIN dental_users u on u.userid=n.signed_id
    LEFT JOIN dental_notes p ON p.notesid = n.parentid group by n.parentid order by n.procedure_date DESC, n.adddate desc) as m where m.signed_on IS NULL OR m.signed_on = ''
    ";

  $num_unsigned = $db->getNumberRows($unsigned_query);

  $preauth_query = "SELECT * FROM dental_insurance_preauth WHERE doc_id = '".$docid."' AND status=".DSS_PREAUTH_REJECTED." AND (viewed IS NULL OR viewed != 1);";

  $num_rejected_preauth = $db->getNumberRows($preauth_query);
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title><?php echo $sitename;?></title>

    <link href="css/admin2.css" rel="stylesheet" type="text/css" />
    <link href="css/task.css" rel="stylesheet" type="text/css" />
    <link href="css/notifications.css" rel="stylesheet" type="text/css" />
    <link href="css/search-hints.css" rel="stylesheet" type="text/css">
    <link href="css/top2.css" rel="stylesheet" type="text/css" />
    
    <script type="text/javascript" src="/manage/admin/script/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="/manage/admin/script/jquery-ui-1.8.22.custom.min.js"></script>
    <script type="text/javascript" src="3rdParty/input_mask/jquery.maskedinput-1.3.min.js"></script>
    <script type="text/javascript" src="3rdParty/jquery.tablesorter.min.js"></script>
    <script type="text/javascript" src="js/masks.js"></script>
    <script type="text/javascript" src="script/logout_timer.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/ddlevelsmenu.js">

    /***********************************************
    * All Levels Navigational Menu- (c) Dynamic Drive DHTML code library (http://www.dynamicdrive.com)
    * This notice MUST stay intact for legal use
    * Visit Dynamic Drive at http://www.dynamicdrive.com/ for full source code
    ***********************************************/

    </script>
    <script language="javascript" type="text/javascript" src="script/validation.js"></script>
    <script language="javascript" type="text/javascript" src="js/top.js?v=20160831"></script>
    <script language="javascript" type="text/javascript" src="script/hideshow.js"></script>
    <script type="text/javascript" src="../../Scripts/sucker_tree.js"></script>
  <?php
    include('includes/calendarinc.php');

    if($_SERVER["SCRIPT_NAME"] == "/manage/q_image.php") {
  ?>

    <!-- Load the Cloud Zoom CSS file -->
    <link href="css/cloud-zoom.css" rel="stylesheet" type="text/css" />
    
    <!-- You can load the jQuery library from the Google Content Network.
    Probably better than from your own server. -->

    <!-- Load the Cloud Zoom JavaScript file -->
    <script type="text/JavaScript" src="js/cloud-zoom.1.0.2.min.js"></script>
  <?php } ?>

    <link rel="stylesheet" href="css/letter-form.css" type="text/css" />
    <link rel="stylesheet" href="css/form.css" type="text/css" />

 <?php if($_SERVER['PHP_SELF'] == "/manage/manage_flowsheet3.php" || $_SERVER['PHP_SELF'] == "/manage/manage_flowsheet4.php") {
    $getstepqrysql = "SELECT * FROM dental_flow_pg2 WHERE patientid='".$_GET['pid']."' LIMIT 1;";

    $stepquery = $db->getRow($getstepqrysql);
    $stepquery = array($stepquery['steparray']);

		if ($db->getNumberRows($getstepqrysql) > 0) {
      $step = explode(",",$stepquery['0']);
      $step_json = json_encode($step);
      $hideallblocks = 1;
    } else {
      $hideallblocks = 2;
    }
  } 
?>

  <script type="text/javascript" src="js/top2.js"></script>

</head>

<!-- onload = disableBackspace(); -->

<body onload="<?php if (!empty($hideallblocks) && $hideallblocks == 2) { echo "hideallblocks();"; } elseif (!empty($hideallblocks) && $hideallblocks == 1) { echo "hideallblocksForFlowsheet($step_json);"; } else { echo ""; } ?>document.getElementById('future_dental_det').style.display = 'none';parent.frames[0].document.getElementById('hideshow1').style.display='block';parent.frames[0].document.getElementById('hideshow2').style.display='none';parent.frames[0].document.getElementById('hideshow3').style.display='none';parent.frames[0].document.getElementById('hideshow4').style.display='none';parent.frames[0].document.getElementById('hideshow5').style.display='none';<?php if(isset($_GET['preview']) && $_GET['preview'] == '1'){?>check();<?php } if(isset($_GET['page']) && $_GET['page'] == 'page2'){ echo "document.getElementById('flowsheet_page1').style.display='none';";
 echo "document.getElementById('flowsheet_page2').style.display='block';";
}?>">

<?php if(isset($_GET['page']) && $_GET['page'] == 'page2') { ?>
  <link href="css/flowsheet_page_page2.css" rel="stylesheet" type="text/css" />
<?php } else { ?>
  <link href="css/flowsheet_page.css" rel="stylesheet" type="text/css" />
<?php } ?>

<link rel="stylesheet" href="admin/popup/popup.css" type="text/css" media="screen" />

<?php if(isset($_GET['pid']) && $_GET['pid']!= '') { ?> 
  <?php
    $title = '';
    $sql = "select * from dental_patients where docid='".$_SESSION['docid']."' AND patientid=".$_GET['pid'];
    
    $my = $db->getResults($sql);
    foreach ($my as $myarray) {
			$premed = $myarray['premedcheck'];

      if ($premed) {
        $title .= "Pre-medication: " . $myarray['premed']."\n";
      }

      $sqlq3 = "select other_allergens, allergenscheck from dental_q_page3_pivot WHERE patientid=".mysqli_real_escape_string($con,$_GET['pid']);

      $myq3array = $db->getRow($sqlq3);
      $allergen = $myq3array['allergenscheck'];

      if ($allergen) {
        $title .= "Allergens: " . $myq3array['other_allergens'];
      }
        $thename= $myarray['firstname']." ".$myarray['lastname'];
      }
  ?>
<?php } ?>

  <script src="admin/popup/popup.js" type="text/javascript"></script>  
  <table width="980" border="0" cellpadding="0" cellspacing="0" align="center">
    <tr>
      <td colspan="2" align="right" ></td>
    </tr>
    <tr>
	    <td valign='top' height="400">
	      <div class="suckertreemenu2">
          <ul id="topmenu">
            <li><a href="#">Manage Settings</a>
              <ul style="z-index:5001;margin-top:-20px;">
                <li>
                  <a class="menu_item" href="#">Directory</a>
                </li>
                <li>
                  <a class="submenu_item" href="manage_contact.php">Contacts</a>
                </li>
                <li>
                  <a class="submenu_item" href="manage_referredby.php">Referral List</a>
                </li>
                <li>
                  <a class="submenu_item" href="manage_sleeplab.php">Sleep Labs</a>
                </li>
                <li>
                  <a class="submenu_item" href="manage_fcontact.php">Corporate Contacts</a>
                </li>
                <li>
                  <a class="menu_item" href="#">DSS Files</a>
                </li>

                <?php 
            			$s = "SELECT * FROM dental_document_category WHERE status=1 ORDER BY name ASC";
            			$sq = $db->getResults($s);
            		  foreach ($sq as $c) {
                ?>

			            <li>
                    <a class="submenu_item" href="view_documents.php?cat=<?php echo  $c['categoryid'];?>"><?php echo  $c['name']; ?></a>
                  </li>

                <?php } ?>

                <li>
                  <a class="menu_item" href="#">Admin</a>
                </li>
                <li>
                  <a class="submenu_item" href="manage_claim_setup.php">Claim Setup</a>
                </li>
	              <li>
                  <a class="submenu_item" href="manage_profile.php">Profile</a>
                </li>
                <li>
                  <a class="submenu_item" href="manage_custom.php">Custom Text</a>
                </li>

                <?php if($_SESSION['userid']==$_SESSION['docid']) { ?>
                  <li>
                    <a class="submenu_item" href="manage_transaction_code.php">Transaction Code</a>
                  </li>
	              <?php } ?>

                <li>
                  <a class="submenu_item" href="manage_staff.php">Staff</a>
                </li>
      		      <li>
                  <a class="submenu_item" href="manage_user_forms.php">Forms</a>
                </li>
      		      <li>
                  <a class="submenu_item" href="manage_manuals.php">Manuals</a>
                </li>
      		      <li>
                  <a class="submenu_item" href="manage_locations.php">Locations</a>
                </li>
                <li>
                  <a class="menu_item" href="pending_patient.php">Pending Patients</a>
                </li>
                <li>
                  <a class="menu_item" href="export_md.php" onclick="return (prompt('Enter password')=='1234');">Export MD</a>
                </li>
              </ul>
	          </li>

            <li>
              <a href="logout.php">Sign Out</a>
            </li>
          </ul>
        </div>

        <script type="text/javascript">
          if (window.task_function) { task_function(); }
        </script>

        <?php
          $task_sql = "select dt.*, du.name, p.firstname, p.lastname from dental_task dt
              JOIN dental_users du ON dt.responsibleid=du.userid
              LEFT JOIN dental_patients p ON p.patientid=dt.patientid
              WHERE (dt.status = '0' OR dt.status IS NULL) AND
              dt.responsibleid='".mysqli_real_escape_string($con,$_SESSION['userid'])."'";

          $num_tasks = $db->getNumberRows($task_sql);
        ?>
          <div id="task_menu" class="task_menu" style="margin-top:8px;float:right">
            <span id="task_header">
              My Tasks (<span id="task_count"><?php echo  $num_tasks; ?></span>)
            </span>

            <div id="task_list" style="border: solid 1px #000; position: absolute; z-index:20;background:#fff;padding:10px;display:none;">

              <?php
                $od_sql = $task_sql . " AND dt.due_date < CURDATE();";
                $tod_sql = $task_sql . " AND dt.due_date = CURDATE();";
                $tom_sql = $task_sql . " AND dt.due_date = DATE_ADD(CURDATE(), INTERVAL 1 DAY);";

                if (date('N') == 7) {
                  $this_sun = date('Y-m-d');
                  $next_mon = date('Y-m-d',  strtotime("next Monday"));
                  $next_sun = date('Y-m-d',  strtotime("next Sunday"));
                } else {
                  $this_sun = date('Y-m-d',  strtotime("next Sunday"));
                  $next_mon = date('Y-m-d',  strtotime("next Monday"));
                  $next_sun = date('Y-m-d',  strtotime("next Sunday + 1 week"));
                }

                $tw_sql = $task_sql . " AND dt.due_date BETWEEN DATE_ADD(CURDATE(), INTERVAL 2 DAY) AND '".$this_sun."'";
                $nw_sql = $task_sql . " AND dt.due_date BETWEEN '".$next_mon."' AND '".$next_sun."'";
                $lat_sql = $task_sql . " AND dt.due_date > '".$next_sun."' ORDER BY dt.due_date ASC";

                $od_q = $db->getResults($od_sql);
                $od_num = count($od_q);

                if ($od_num > 0) {
              ?>

                <h4 id="task_od_header" style="color:red;" class="task_od_header">Overdue</h4>
                <ul id="task_od_list">

                  <?php foreach ($od_q as $od_r) { ?>
                    <li class="task_item task_<?php echo  $od_r['id']; ?>" style="clear:both;">
                      <div class="task_extra" id="task_extra_<?php echo  $od_r['id']; ?>" >
                        <a href="#" onclick="delete_task('<?php echo  $od_r['id']; ?>')" class="task_delete"></a>

                        <a href="#" onclick="loadPopup('add_task.php?id=<?php echo  $od_r['id']; ?>')" class="task_edit">Edit</a>
                      </div>

                      <input type="checkbox" class="task_status" style="float:left;" value="<?php echo  $od_r['id']; ?>" />

                      <div style="float:left; width:170px;"><?php echo $od_r['task']; ?>
                        <?php
                          if($od_r['firstname']!='' && $od_r['lastname']!='') {
                            echo ' (<a href="add_patient.php?ed='.$od_r['patientid'].'&preview=1&addtopat=1&pid='.$od_r['patientid'].'">'.$od_r['firstname'].' '. $od_r['lastname'].'</a>)';
                          }
                        ?>
                      </div>
                    </li>
                  <?php } ?>

                </ul>

              <?php }
                $tod_q = $db->getResults($tod_sql);
                $tod_num = count($tod_q);

                if ($tod_num > 0) {
              ?>

                <h4 id="task_tod_header" class="task_tod_header">Today</h4>
                <ul id="task_tod_list">

                  <?php foreach ($tod_q as $od_r ) { ?>
                    <li class="task_item task_<?php echo  $od_r['id']; ?>" style="clear:both;">
                      <div class="task_extra" id="task_extra_<?php echo  $od_r['id']; ?>" >
                        <a href="#" onclick="delete_task('<?php echo  $od_r['id']; ?>')" class="task_delete"></a>
                        <a href="#" onclick="loadPopup('add_task.php?id=<?php echo  $od_r['id']; ?>')" class="task_edit">Edit</a>
                      </div>

                      <input type="checkbox" class="task_status" style="float:left;" value="<?php echo  $od_r['id']; ?>" />

                      <div style="float:left; width:170px;"><?php echo $od_r['task']; ?>
                        <?php
                          if($od_r['firstname']!='' && $od_r['lastname']!=''){
                            echo ' (<a href="add_patient.php?ed='.$od_r['patientid'].'&preview=1&addtopat=1&pid='.$od_r['patientid'].'">'.$od_r['firstname'].' '. $od_r['lastname'].'</a>)';
                          }
                        ?>
                      </div>
                    </li>
                  <?php } ?>

                </ul>

              <?php }
                $tom_q = $db->getResults($tom_sql);
                $tom_num = count($tom_q);
                if ($tom_num > 0) {
              ?>

                <h4 id="task_tom_header" class="task_tom_header">Tomorrow</h4>
                <ul id="task_tom_list">

                  <?php foreach ($tom_q as $od_r) { ?>             
                    <li class="task_item task_<?php echo  $od_r['id']; ?>" style="clear:both;">
                      <div class="task_extra" id="task_extra_<?php echo  $od_r['id']; ?>" >
                        <a href="#" onclick="delete_task('<?php echo  $od_r['id']; ?>')" class="task_delete"></a>
                        <a href="#" onclick="loadPopup('add_task.php?id=<?php echo  $od_r['id']; ?>')" class="task_edit">Edit</a>
                      </div>

                      <input type="checkbox" class="task_status" style="float:left;" value="<?php echo  $od_r['id']; ?>" />

                      <div style="float:left; width:170px;"><?php echo $od_r['task']; ?>
                        <?php
                          if($od_r['firstname']!='' && $od_r['lastname']!=''){
                            echo ' (<a href="add_patient.php?ed='.$od_r['patientid'].'&preview=1&addtopat=1&pid='.$od_r['patientid'].'">'.$od_r['firstname'].' '. $od_r['lastname'].'</a>)';
                          }
                        ?>
                      </div>
                    </li>
                  <?php } ?>

                </ul>

              <?php }
                $tw_q = $db->getResults($tw_sql);
                $tw_num = count($tw_q);
                if ($tw_num > 0) {
              ?>

                <h4 id="task_tw_header" class="task_tw_header">This Week</h4>
                <ul id="task_tw_list">

                  <?php foreach ($tw_q as $od_r) { ?>
                    <li class="task_item task_<?php echo  $od_r['id']; ?>" style="clear:both;">
                      <div class="task_extra" id="task_extra_<?php echo  $od_r['id']; ?>" >
                        <a href="#" onclick="delete_task('<?php echo  $od_r['id']; ?>')" class="task_delete"></a>
                        <a href="#" onclick="loadPopup('add_task.php?id=<?php echo  $od_r['id']; ?>')" class="task_edit">Edit</a>
                      </div>

                      <input type="checkbox" class="task_status" style="float:left;" value="<?php echo  $od_r['id']; ?>" />

                      <div style="float:left; width:170px;"><?php echo $od_r['task']; ?>
                        <?php
                          if($od_r['firstname']!='' && $od_r['lastname']!=''){
                            echo ' (<a href="add_patient.php?ed='.$od_r['patientid'].'&preview=1&addtopat=1&pid='.$od_r['patientid'].'">'.$od_r['firstname'].' '. $od_r['lastname'].'</a>)';
                          }
                        ?>
                      </div>
                    </li>
                  <?php } ?>

                </ul>

              <?php }
                $nw_q = $db->getResults($nw_sql);
                $nw_num = count($nw_q);

                if ($nw_num > 0) {
              ?>

                <h4 id="task_nw_header" class="task_nw_header">Next Week</h4>
                <ul id="task_nw_list">

                  <?php foreach ($nw_q as $od_r) { ?>
                    <li class="task_item task_<?php echo  $od_r['id']; ?>" style="clear:both;">
                      <div class="task_extra" id="task_extra_<?php echo  $od_r['id']; ?>" >
                        <a href="#" onclick="delete_task('<?php echo  $od_r['id']; ?>')" class="task_delete"></a>
                        <a href="#" onclick="loadPopup('add_task.php?id=<?php echo  $od_r['id']; ?>')" class="task_edit">Edit</a>
                      </div>

                      <input type="checkbox" class="task_status" style="float:left;" value="<?php echo  $od_r['id']; ?>" />

                      <div style="float:left; width:170px;"><?php echo $od_r['task']; ?>
                        <?php
                          if($od_r['firstname']!='' && $od_r['lastname']!=''){
                            echo ' (<a href="add_patient.php?ed='.$od_r['patientid'].'&preview=1&addtopat=1&pid='.$od_r['patientid'].'">'.$od_r['firstname'].' '. $od_r['lastname'].'</a>)';
                          }
                        ?>
                      </div>
                    </li>
                  <?php } ?>

                </ul>
              
              <?php } 
                $lat_q = $db->getResults($lat_sql);
                $lat_num = count($lat_q);

                if ($lat_num > 0) {
              ?>

                <h4 id="task_lat_header" class="task_lat_header">Later</h4>
                <ul id="task_lat_list">

                  <?php foreach ($lat_q as $od_r) { ?>
                    <li class="task_item task_<?php echo  $od_r['id']; ?>" style="clear:both;">
                      <div class="task_extra" id="task_extra_<?php echo  $od_r['id']; ?>" >
                        <a href="#" onclick="delete_task('<?php echo  $od_r['id']; ?>')" class="task_delete"></a>
                        <a href="#" onclick="loadPopup('add_task.php?id=<?php echo  $od_r['id']; ?>')" class="task_edit">Edit</a>
                      </div>

                      <input type="checkbox" class="task_status" style="float:left;" value="<?php echo  $od_r['id']; ?>" />

                      <div style="float:left; width:170px;">
                        <?php echo  date('M d', strtotime($od_r['due_date'])); ?>
                        -
                        <?php echo $od_r['task']; ?>

                        <?php
                          if($od_r['firstname']!='' && $od_r['lastname']!=''){
                            echo ' (<a href="add_patient.php?ed='.$od_r['patientid'].'&preview=1&addtopat=1&pid='.$od_r['patientid'].'">'.$od_r['firstname'].' '. $od_r['lastname'].'</a>)';
                          }
                        ?>
                      </div>
                    </li>
                  <?php } ?>

                </ul>

              <?php } ?>

              <?php
                if ($od_num == 0 && $tod_num == 0 && $tom_num == 0) {
                }
              ?>

              <br /><br />

              <a href="manage_tasks.php" class="button" style="padding:2px 10px;">View All</a>
            </div>
          </div> 
          <a style="display:block; margin-right:20px;  margin-top:8px; float:right;" href="calendar.php">Scheduler</a>

          <script type="text/javascript" src="js/task.js"></script> 
          <script type="text/javascript" src="script/autocomplete.js?v=20160719"></script>
 
          <div style="height:89px; width:980px; background:url(images/dss_01.png) #0b5c82 no-repeat top left;">   
            <div style="margin-top:10px; margin-left:20px; float:left;">
              <a href="/manage" id="logo"></a>

              <div id="patient_search_div">
                <input type="text" id="patient_search"  style="width:200px;" value="Patient Search" name="q" autocomplete="off" />

	              <br />

              	<div id="search_hints"  class="search_hints" style="display:none;">
              		<ul id="patient_list">
              			<li class="template" style="display:none">Doe, John S</li>
              		</ul>
              	</div>
              </div> 

              <button onclick="window.location='add_patient.php'" style="margin-top:27px;">+ Add Patient</button>

              <button onclick="loadPopup('add_task.php<?php echo  (isset($_GET['pid']))?'?pid='.$_GET['pid']:''; ?>')" style="margin-top:27px;">+ Add Task</button>
            </div>

            <?php
              $logo_sql = "SELECT c.logo FROM companies c
        			   JOIN dental_user_company uc ON uc.companyid = c.id
        			   WHERE uc.userid='".$_SESSION['userid']."'";

              $logo_r = $db->getRow($logo_sql);

              if($logo_r['logo'] != '') {
            ?>

              <div style="float:right;margin:13px 15px 0 0;"><img src="q_file/<?php echo $logo_r['logo']; ?>" /></div> 
            <?php } ?>

            <div style="clear:both;"></div>
          </div>
          
          <div style="background:url(images/dss_03.jpg) #0b5c82 repeat-y top left;width:100%;">
            <div style="width:98.6%; background:#00457c;margin:0 auto;">
            
              <?php if (isset($_GET['pid']) && $_GET['pid'] != '') { ?>

                <div id="patient_name_div" <?php echo  (strlen($thename)>20) ? 'style="font-size:14px"' : ''; ?>>
                  <?php echo  $thename; ?>

		              <?php
                    if ($premed == 1 || $allergen == 1) {
                      echo "<a href=\"q_page3.php?pid=".$_GET['pid']."\" title=\"".$title."\" style=\"font-weight:bold; font-size:18px; color:#FF0000;\">*Med</a>";
                    }
                  ?>

                  <?php
                    $t_sql = "select dt.*, du.name, p.firstname, p.lastname from dental_task dt JOIN dental_users du ON dt.responsibleid=du.userid LEFT JOIN dental_patients p ON p.patientid=dt.patientid WHERE (dt.status = '0' OR
                      dt.status IS NULL) AND (du.docid='".mysqli_real_escape_string($con,$_SESSION['docid'])."' OR du.userid='".mysqli_real_escape_string($con,$_SESSION['docid'])."') AND dt.patientid='".mysqli_real_escape_string($con,$_GET['pid'])."'";

                    $t_num_sql = $t_sql;
                    $num_pat_tasks = $db->getNumberRows($t_num_sql);

                    if ($num_pat_tasks > 0) {
                  ?>

                    <div class="task_menu" id="pat_task_menu" style="float:right; margin-right:10px;">
                      <span id="pat_task_header" style="font-size:14px; font-weight:normal">Tasks(<?php echo  $num_pat_tasks; ?>)</span>

                      <?php
                        $od_sql = $t_sql . " AND dt.due_date < CURDATE();";
                        $tod_sql = $t_sql . " AND dt.due_date = CURDATE();";
                        $tom_sql = $t_sql . " AND dt.due_date = DATE_ADD(CURDATE(), INTERVAL 1 DAY);";
                        $fut_sql = $t_sql . " AND dt.due_date > DATE_ADD(CURDATE(), INTERVAL 1 DAY);";
                      ?>

                      <div class="task_list" id="pat_task_list" style="display:none;">

                        <?php
                          $od_q = $db->getResults($od_sql);
                          $od_num = count($od_q);

                          if ($od_num > 0) {
                        ?>

                          <h4 id="pat_task_od_header" style="color:red" class="task_od_header">Overdue</h4>
                          <ul id="pat_task_od_list">

                            <?php foreach ($od_q as $od_r) { ?>
                              <li class="task_item task_<?php echo  $od_r['id']; ?>" style="clear:both;">
                                <div class="task_extra" id="task_extra_<?php echo  $od_r['id']; ?>" >
                                  <a href="#" onclick="delete_task('<?php echo  $od_r['id']; ?>')" class="task_delete"></a>
                                  <a href="#" onclick="loadPopup('add_task.php?id=<?php echo  $od_r['id']; ?>')" class="task_edit">Edit</a>
                                </div>

                                <input type="checkbox" class="task_status" value="<?php echo  $od_r['id']; ?>" />

                                <?php echo $od_r['task']; ?>

                                <?php
                                  if($od_r['firstname']!='' && $od_r['lastname']!=''){
                                    echo ' (<a href="add_patient.php?ed='.$od_r['patientid'].'&preview=1&addtopat=1&pid='.$od_r['patientid'].'">'.$od_r['firstname'].' '. $od_r['lastname'].'</a>)';
                                  }
                                ?>
                              </li>
                            <?php } ?>

                          </ul>

                        <?php }
                          $od_q = $db->getResults($tod_sql);
                          $od_num = count($od_q);

                          if ($od_num > 0) {
                        ?>

                          <h4 id="pat_task_tod_header" class="task_tod_header">Today</h4>
                          <ul id="pat_task_tod_list">

                          <?php foreach ($od_q as $od_r) { ?>
                            <li class="task_item task_<?php echo  $od_r['id']; ?>" style="clear:both;">
                              <div class="task_extra" id="task_extra_<?php echo  $od_r['id']; ?>" >
                                <a href="#" onclick="delete_task('<?php echo  $od_r['id']; ?>')" class="task_delete"></a>
                                <a href="#" onclick="loadPopup('add_task.php?id=<?php echo  $od_r['id']; ?>')" class="task_edit">Edit</a>
                              </div>

                              <input type="checkbox" class="task_status" value="<?php echo  $od_r['id']; ?>" />

                              <?php echo $od_r['task']; ?>

                              <?php
                                if($od_r['firstname']!='' && $od_r['lastname']!=''){
                                  echo ' (<a href="add_patient.php?ed='.$od_r['patientid'].'&preview=1&addtopat=1&pid='.$od_r['patientid'].'">'.$od_r['firstname'].' '. $od_r['lastname'].'</a>)';
                                }
                              ?>
                            </li>
                          <?php } ?>

                        </ul>

                      <?php } 
                        $od_q = $db->getResults($tom_sql);
                        $od_num = count($od_q);

                        if ($od_num > 0) {
                      ?>

                        <h4 id="pat_task_tom_header" class="task_tom_header">Tomorrow</h4>
                        <ul id="pat_task_tom_list">

                          <?php foreach ($od_q as $od_r) { ?>
                            <li class="task_item task_<?php echo  $od_r['id']; ?>" style="clear:both;">
                              <div class="task_extra" id="task_extra_<?php echo  $od_r['id']; ?>" >
                                <a href="#" onclick="delete_task('<?php echo  $od_r['id']; ?>')" class="task_delete"></a>
                                <a href="#" onclick="loadPopup('add_task.php?id=<?php echo  $od_r['id']; ?>')" class="task_edit">Edit</a>
                              </div>

                              <input type="checkbox" class="task_status" value="<?php echo  $od_r['id']; ?>" />

                              <?php echo $od_r['task']; ?>

                              <?php
                                if($od_r['firstname']!='' && $od_r['lastname']!=''){
                                  echo ' (<a href="add_patient.php?ed='.$od_r['patientid'].'&preview=1&addtopat=1&pid='.$od_r['patientid'].'">'.$od_r['firstname'].' '. $od_r['lastname'].'</a>)';
                                }
                              ?>
                            </li>
                          <?php } ?>

                        </ul>

                      <?php } 
                        $od_q = $db->getResults($fut_sql);
                        $od_num = count($od_q);

                        if ($od_num > 0) {
                      ?>

                        <h4 id="pat_task_fut_header" class="task_fut_header">Future</h4>
                        <ul id="pat_task_fut_list">

                          <?php foreach($od_q as $od_r) { ?>
                            <li class="task_item task_<?php echo  $od_r['id']; ?>" style="clear:both;">
                              <div class="task_extra" id="task_extra_<?php echo  $od_r['id']; ?>" >
                                <a href="#" onclick="delete_task('<?php echo  $od_r['id']; ?>')" class="task_delete"></a>
                                <a href="#" onclick="loadPopup('add_task.php?id=<?php echo  $od_r['id']; ?>')" class="task_edit">Edit</a>
                              </div>

                              <input type="checkbox" class="task_status" value="<?php echo  $od_r['id']; ?>" />

                              <?php echo $od_r['task']; ?>

                              <?php
                                if($od_r['firstname']!='' && $od_r['lastname']!=''){
                                  echo ' (<a href="add_patient.php?ed='.$od_r['patientid'].'&preview=1&addtopat=1&pid='.$od_r['patientid'].'">'.$od_r['firstname'].' '. $od_r['lastname'].'</a>)';
                                }
                              ?>

                            </li>
                          <?php } ?>

                        </ul>

                      <?php } ?>

                    </div>
                </div>

              <?php } ?>

            </div>

          <?php } ?>

          <div class="suckertreemenu">
            <ul id="treemenu1" style="padding-top:3px;">
              <li>
                <a href="manage_patient.php">PATIENT</a>

                <ul>
                  <li>
                    <a href="manage_patient.php">Manage Patients</a>
                  </li>
                  <li>
                    <a href="#">Directory</a>

                    <ul>
                       <li>
                        <a href="manage_contact.php">Contacts</a>
                      </li>
                       <li>
                        <a href="manage_referredby.php">Referral List</a>
                      </li>
                       <li>
                        <a href="manage_sleeplab.php">Sleep Labs</a>
                      </li>
                       <li>
                        <a href="manage_fcontact.php">Corporate Contacts</a>
                      </li>    
                    </ul>
                  </li>
                </ul>
              </li>

              <li>
                <a href="#">REPORTS</a>

                <ul>
                  <li>
                    <a href="ledger_reportfull.php">Ledger</a>
                  </li>
                  <li>
                    <a href="manage_claims.php">Claims (<?php echo  $num_pending_claims; ?>)</a>
                  </li>
                  <li>
                    <a href="performance.php">Performance</a>
                  </li>
                  <li>
                    <a href="manage_screeners.php">Pt. Screener</a>
                  </li>
                </ul>
              </li>

              <?php
                $mess_count = $pending_letters + $num_preauth + $num_pc + $num_pi + $num_c;
                $mess_count = $pending_letters + $num_preauth + $num_rejected_preauth + $num_pc + $num_pi + $num_c + $num_bounce;
              ?>

              <li>
                <a href="#">MESSAGES (<?php echo $mess_count; ?>)</a>

                <ul>
                  <li>
                    <a <?php echo "href='letters.php?status=pending'"; ?>>Pending Letters (<?php echo $pending_letters; ?>)</a>
                  </li>
                  <li>
                    <a <?php echo "href='manage_vobs.php'"; ?>>VOBs (<?php echo  $num_preauth; ?>)</a>
                  </li>
                  <li>
                    <a <?php echo "href='manage_patient_contacts.php'"; ?>>Patient Contacts (<?php echo  $num_pc; ?>)</a>
                  </li>
                  <li>
                    <a <?php echo "href='manage_patient_insurance.php'"; ?>>Patient Insurance (<?php echo  $num_pi; ?>)</a>
                  </li>
                  <li>
                    <a <?php echo "href='manage_patient_changes.php'"; ?>>Patient Changes (<?php echo  $num_c; ?>)</a>
                  </li>
                  <li>
                    <a href="manage_vobs.php?status=<?php echo  DSS_PREAUTH_REJECTED; ?>&viewed=0">Alerts (<?php echo  $num_rejected_preauth; ?>)</a>
                  </li>
                  <li>
                    <a href="manage_email_bounces.php">Email Bounces (<?php echo  $num_bounce; ?>)</a>
                  </li>
                  <li>
                    <a href="manage_tasks.php">Tasks (<?php echo  $num_tasks; ?>)</a>
                  </li>
                </ul>
            </ul>
          </li>
        </ul>
      </div>

      <?php if (isset($_GET['pid']) && $_GET['pid'] != '') { ?>

        <div id="patient_nav">
          <ul>
            <li>
              <a class="<?php echo ($_SERVER['PHP_SELF'] == '/manage/manage_flowsheet3.php')?'nav_active':'';?>" <?php echo "href='manage_flowsheet3.php?pid=".$_GET['pid']."&addtopat=1'"; ?>>Tracker</a>
            </li>
            <li>
              <a class="<?php echo ($_SERVER['PHP_SELF'] == '/manage/dss_summ.php')?'nav_active':'';?>" <?php echo "href='dss_summ.php?pid=".$_GET['pid']."&addtopat=1'"; ?>>Summary Sheet</a>
            </li>
            <li>
              <a class="<?php echo ($_SERVER['PHP_SELF'] == '/manage/manage_ledger.php')?'nav_active':'';?>" <?php echo "href='manage_ledger.php?pid=".$_GET["pid"]."&addtopat=1'"; ?>>Ledger</a>
            </li>
            <li>
              <a class="<?php echo ($_SERVER['PHP_SELF'] == '/manage/manage_insurance.php')?'nav_active':'';?>" <?php echo "href='manage_insurance.php?pid=".$_GET["pid"]."&addtopat=1'"; ?>>Insurance</a>
            </li>
            <li>
              <a class="<?php echo ($_SERVER['PHP_SELF'] == '/manage/manage_progress_notes.php')?'nav_active':'';?>" <?php echo "href='dss_summ.php?sect=notes&pid=".$_GET["pid"]."&addtopat=1'"; ?>>Progress Notes</a>
            </li>
            <li>
              <a class="<?php echo ($_SERVER['PHP_SELF'] == '/manage/patient_letters.php')?'nav_active':'';?>" <?php echo "href='dss_summ.php?sect=letters&pid=".$_GET['pid']."&addtopat=1'"; ?>>Letters</a>
            </li>
            <li>
              <a class="<?php echo ($_SERVER['PHP_SELF'] == '/manage/q_image.php')?'nav_active':'';?>" href="q_image.php?pid=<?php echo  $_GET['pid'] ?>">Images</a>
            </li>
            <li>
              <a class="<?php echo (strpos($_SERVER['PHP_SELF'],'q_page') || strpos($_SERVER['PHP_SELF'],'q_sleep'))?'nav_active':'';?>" href="q_page1.php?pid=<?php echo  $_GET['pid'] ?>&addtopat=1">Questionnaire</a>
            </li>
            <li>
              <a class="<?php echo (strpos($_SERVER['PHP_SELF'],'ex_page'))?'nav_active':'';?>" href="ex_page4.php?pid=<?php echo  $_GET['pid'] ?>&addtopat=1">Clinical Exam</a>
            </li>
            <li class="last">
              <a class="<?php echo ($_SERVER['PHP_SELF'] == '/manage/add_patient.php')?'nav_active':'';?>" href="add_patient.php?ed=<?php echo  $_GET['pid'] ?>&preview=1&addtopat=1&pid=<?php echo  $_GET['pid'] ?>">Patient Info</a>
            </li>
          </ul>
        </div>

      <?php } else { ?>

        <div style="clear:both;"></div>

      <?php } ?>

    </div>

    <div style="clear:both;"></div>
  </div>

  <div style="background:url(images/dss_03.jpg) repeat-y top left #FFFFFF;" id="contentMain">
    <div style="clear:both;"></div>

    <?php if (isset($_GET['pid']) && $_GET['pid'] != ''){ ?>
      <div style="margin-left:20px;float:left;width:400px;display:none;">
        <?php echo "You are currently in a patient chart - " ?>

        <a href="manage_patient.php" target="_self" style="font-weight:bold;">BACK TO PATIENT LIST</a>
      </div>

      <div style="float:right;width:300px;"> 
        <?php
          $sql = "select * from dental_patients where docid='".$_SESSION['docid']."' AND patientid=".$_GET['pid'];

          $my = $db->getResults($sql);
          foreach ($my as $myarray) {
            $thename = $myarray['firstname']." ".$myarray['lastname'];
            if ($myarray["premedcheck"] == 1) {
            }
          }
        ?>
      </div>

    <?php } ?>

    <br />

    <?php
      if (isset($_GET['pid'])) {
	      $s = "SELECT * FROM dental_patients WHERE parent_patientid='".mysqli_real_escape_string($con,$_GET['pid'])."'";

        $n = $db->getNumberRows($q);
        $pat = $db->getRow($q);
				$n = num_patient_changes($_GET['pid']);
                                
        $contacts_sql = "SELECT pc.id, pc.contacttype, pc.firstname, pc.lastname, pc.address1, pc.address2, pc.city, pc.state, pc.zip, pc.phone,
          p.firstname as patfirstname, p.lastname as patlastname
          FROM dental_patient_contacts pc 
          INNER JOIN dental_patients p ON pc.patientid=p.patientid
          WHERE p.docid='".$_SESSION['docid']."' AND
          p.patientid='".mysqli_real_escape_string($con,$_GET['pid'])."'";

        $total_contacts = $db->getNumberRows($contacts_sql);

        $insurance_sql = "SELECT pi.*, p.firstname as patfirstname, p.lastname as patlastname FROM dental_patient_insurance pi INNER JOIN dental_patients p ON pi.patientid=p.patientid 
          WHERE p.docid='".$_SESSION['docid']."' AND
          p.patientid='".mysqli_real_escape_string($con,$_GET['pid'])."'";

        $total_insurance = $db->getNumberRows($insurance_sql);

        if (($n + $total_contacts + $total_insurance) > 0) {
    ?>
          <a class="warning" href="patient_changes.php?pid=<?php echo $_GET['pid'];?>">
            <span>Warning! Patient has updated their PROFILE via the online patient portal, and you have not yet accepted these changes. Please click this box to review patient changes.</span>
          </a>
    <?php } 
        $exist_sql = "SELECT symptoms_status, treatments_status, history_status FROM dental_patients WHERE patientid='".mysqli_real_escape_string($con,$_GET['pid'])."'";

        $exist_row = $db->getRow($exist_sql);

	      if ($exist_row['symptoms_status'] == 2 || $exist_row['treatments_status'] == 2 || $exist_row['history_status'] == 2 || $exist_row['sleep_status'] == 2) {
    ?>
          <a class="warning" href="q_page1.php?pid=<?php echo  $_GET['pid']; ?>&addtopat=1" >
            <span>Warning! Patient has updated their QUESTIONNAIRE via the online patient portal, and you have not yet accepted these changes. Please click this box to review patient changes.</span>
          </a>	  
    <?php }
      $email_sql = "SELECT patientid FROM dental_patients WHERE email_bounce=1 AND patientid='".mysqli_real_escape_string($con,$_GET['pid'])."'";

      if ($db->getNumberRows($email_sql)>0) { 
    ?>
        <a class="warning" href="add_patient.php?ed=<?php echo  $_GET['pid']; ?>&pid=<?php echo  $_GET['pid']; ?>&addtopat=1" >
          <span>Warning! Email sent to this patient has bounced. Please click to check patients email.</span>
        </a>
    <?php }
      }

      $sql = "SELECT use_letters from dental_users WHERE userid='".mysqli_real_escape_string($con,$_SESSION['docid'])."'";

      $r = $db->getRow($sql);
      $use_letters = ($r['use_letters']=='1');
    ?>
